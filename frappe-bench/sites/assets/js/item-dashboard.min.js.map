{"version":3,"file":"item-dashboard.min.js","sources":["../../../apps/erpnext/erpnext/stock/dashboard/item_dashboard.js"],"sourcesContent":["frappe.provide('erpnext.stock');\n\nerpnext.stock.ItemDashboard = Class.extend({\n\tinit: function(opts) {\n\t\t$.extend(this, opts);\n\t\tthis.make();\n\t},\n\tmake: function() {\n\t\tvar me = this;\n\t\tthis.start = 0;\n\t\tif(!this.sort_by) {\n\t\t\tthis.sort_by = 'projected_qty';\n\t\t\tthis.sort_order = 'asc';\n\t\t}\n\n\t\tthis.content = $(frappe.render_template('item_dashboard')).appendTo(this.parent);\n\t\tthis.result = this.content.find('.result');\n\n\t\tthis.content.on('click', '.btn-move', function() {\n\t\t\thandle_move_add($(this), \"Move\")\n\t\t});\n\n\t\tthis.content.on('click', '.btn-add', function() {\n\t\t\thandle_move_add($(this), \"Add\")\n\t\t});\n\n\t\tfunction handle_move_add(element, action) {\n\t\t\tlet item = unescape(element.attr('data-item'));\n\t\t\tlet warehouse = unescape(element.attr('data-warehouse'));\n\t\t\tlet actual_qty = unescape(element.attr('data-actual_qty'));\n\t\t\tlet disable_quick_entry = Number(unescape(element.attr('data-disable_quick_entry')));\n\t\t\tlet entry_type = action === \"Move\" ? \"Material Transfer\": null;\n\n\t\t\tif (disable_quick_entry) {\n\t\t\t\topen_stock_entry(item, warehouse, entry_type);\n\t\t\t} else {\n\t\t\t\tif (action === \"Add\") {\n\t\t\t\t\tlet rate = unescape($(this).attr('data-rate'));\n\t\t\t\t\terpnext.stock.move_item(item, null, warehouse, actual_qty, rate, function() { me.refresh(); });\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\terpnext.stock.move_item(item, warehouse, null, actual_qty, null, function() { me.refresh(); });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction open_stock_entry(item, warehouse, entry_type) {\n\t\t\tfrappe.model.with_doctype('Stock Entry', function() {\n\t\t\t\tvar doc = frappe.model.get_new_doc('Stock Entry');\n\t\t\t\tif (entry_type) doc.stock_entry_type = entry_type;\n\n\t\t\t\tvar row = frappe.model.add_child(doc, 'items');\n\t\t\t\trow.item_code = item;\n\t\t\t\trow.s_warehouse = warehouse;\n\n\t\t\t\tfrappe.set_route('Form', doc.doctype, doc.name);\n\t\t\t})\n\t\t}\n\n\t\t// more\n\t\tthis.content.find('.btn-more').on('click', function() {\n\t\t\tme.start += 20;\n\t\t\tme.refresh();\n\t\t});\n\n\t},\n\trefresh: function() {\n\t\tif(this.before_refresh) {\n\t\t\tthis.before_refresh();\n\t\t}\n\n\t\tvar me = this;\n\t\tfrappe.call({\n\t\t\tmethod: 'erpnext.stock.dashboard.item_dashboard.get_data',\n\t\t\targs: {\n\t\t\t\titem_code: this.item_code,\n\t\t\t\twarehouse: this.warehouse,\n\t\t\t\titem_group: this.item_group,\n\t\t\t\tstart: this.start,\n\t\t\t\tsort_by: this.sort_by,\n\t\t\t\tsort_order: this.sort_order,\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tme.render(r.message);\n\t\t\t}\n\t\t});\n\t},\n\trender: function(data) {\n\t\tif(this.start===0) {\n\t\t\tthis.max_count = 0;\n\t\t\tthis.result.empty();\n\t\t}\n\n\t\tvar context = this.get_item_dashboard_data(data, this.max_count, true);\n\t\tthis.max_count = this.max_count;\n\n\t\t// show more button\n\t\tif(data && data.length===21) {\n\t\t\tthis.content.find('.more').removeClass('hidden');\n\n\t\t\t// remove the last element\n\t\t\tdata.splice(-1);\n\t\t} else {\n\t\t\tthis.content.find('.more').addClass('hidden');\n\t\t}\n\n\t\t// If not any stock in any warehouses provide a message to end user\n\t\tif (context.data.length > 0) {\n\t\t\t$(frappe.render_template('item_dashboard_list', context)).appendTo(this.result);\n\t\t} else {\n\t\t\tvar message = __(\" Currently no stock available in any warehouse\")\n\t\t\t$(\"<span class='text-muted small'>\"+message+\"</span>\").appendTo(this.result);\n\t\t}\n\t},\n\tget_item_dashboard_data: function(data, max_count, show_item) {\n\t\tif(!max_count) max_count = 0;\n\t\tif(!data) data = [];\n\n\t\tdata.forEach(function(d) {\n\t\t\td.actual_or_pending = d.projected_qty + d.reserved_qty + d.reserved_qty_for_production + d.reserved_qty_for_sub_contract;\n\t\t\td.pending_qty = 0;\n\t\t\td.total_reserved = d.reserved_qty + d.reserved_qty_for_production + d.reserved_qty_for_sub_contract;\n\t\t\tif(d.actual_or_pending > d.actual_qty) {\n\t\t\t\td.pending_qty = d.actual_or_pending - d.actual_qty;\n\t\t\t}\n\n\t\t\tmax_count = Math.max(d.actual_or_pending, d.actual_qty,\n\t\t\t\td.total_reserved, max_count);\n\t\t});\n\n\t\tvar can_write = 0;\n\t\tif(frappe.boot.user.can_write.indexOf(\"Stock Entry\")>=0){\n\t\t\tcan_write = 1;\n\t\t}\n\n\t\treturn {\n\t\t\tdata: data,\n\t\t\tmax_count: max_count,\n\t\t\tcan_write:can_write,\n\t\t\tshow_item: show_item || false\n\t\t}\n\t}\n})\n\nerpnext.stock.move_item = function(item, source, target, actual_qty, rate, callback) {\n\tvar dialog = new frappe.ui.Dialog({\n\t\ttitle: target ? __('Add Item') : __('Move Item'),\n\t\tfields: [\n\t\t\t{fieldname: 'item_code', label: __('Item'),\n\t\t\t\tfieldtype: 'Link', options: 'Item', read_only: 1},\n\t\t\t{fieldname: 'source', label: __('Source Warehouse'),\n\t\t\t\tfieldtype: 'Link', options: 'Warehouse', read_only: 1},\n\t\t\t{fieldname: 'target', label: __('Target Warehouse'),\n\t\t\t\tfieldtype: 'Link', options: 'Warehouse', reqd: 1},\n\t\t\t{fieldname: 'qty', label: __('Quantity'), reqd: 1,\n\t\t\t\tfieldtype: 'Float', description: __('Available {0}', [actual_qty]) },\n\t\t\t{fieldname: 'rate', label: __('Rate'), fieldtype: 'Currency', hidden: 1 },\n\t\t],\n\t})\n\tdialog.show();\n\tdialog.get_field('item_code').set_input(item);\n\n\tif(source) {\n\t\tdialog.get_field('source').set_input(source);\n\t} else {\n\t\tdialog.get_field('source').df.hidden = 1;\n\t\tdialog.get_field('source').refresh();\n\t}\n\n\tif(rate) {\n\t\tdialog.get_field('rate').set_value(rate);\n\t\tdialog.get_field('rate').df.hidden = 0;\n\t\tdialog.get_field('rate').refresh();\n\t}\n\n\tif(target) {\n\t\tdialog.get_field('target').df.read_only = 1;\n\t\tdialog.get_field('target').value = target;\n\t\tdialog.get_field('target').refresh();\n\t}\n\n\tdialog.set_primary_action(__('Submit'), function() {\n\t\tvar values = dialog.get_values();\n\t\tif(!values) {\n\t\t\treturn;\n\t\t}\n\t\tif(source && values.qty > actual_qty) {\n\t\t\tfrappe.msgprint(__('Quantity must be less than or equal to {0}', [actual_qty]));\n\t\t\treturn;\n\t\t}\n\t\tif(values.source === values.target) {\n\t\t\tfrappe.msgprint(__('Source and target warehouse must be different'));\n\t\t}\n\n\t\tfrappe.call({\n\t\t\tmethod: 'erpnext.stock.doctype.stock_entry.stock_entry_utils.make_stock_entry',\n\t\t\targs: values,\n\t\t\tfreeze: true,\n\t\t\tcallback: function(r) {\n\t\t\t\tfrappe.show_alert(__('Stock Entry {0} created',\n\t\t\t\t\t['<a href=\"#Form/Stock Entry/'+r.message.name+'\">' + r.message.name+ '</a>']));\n\t\t\t\tdialog.hide();\n\t\t\t\tcallback(r);\n\t\t\t},\n\t\t});\n\t});\n\n\t$('<p style=\"margin-left: 10px;\"><a class=\"link-open text-muted small\">'\n\t\t+ __(\"Add more items or open full form\") + '</a></p>')\n\t\t.appendTo(dialog.body)\n\t\t.find('.link-open')\n\t\t.on('click', function() {\n\t\t\tfrappe.model.with_doctype('Stock Entry', function() {\n\t\t\t\tvar doc = frappe.model.get_new_doc('Stock Entry');\n\t\t\t\tdoc.from_warehouse = dialog.get_value('source');\n\t\t\t\tdoc.to_warehouse = dialog.get_value('target');\n\t\t\t\tvar row = frappe.model.add_child(doc, 'items');\n\t\t\t\trow.item_code = dialog.get_value('item_code');\n\t\t\t\trow.f_warehouse = dialog.get_value('target');\n\t\t\t\trow.t_warehouse = dialog.get_value('target');\n\t\t\t\trow.qty = dialog.get_value('qty');\n\t\t\t\trow.conversion_factor = 1;\n\t\t\t\trow.transfer_qty = dialog.get_value('qty');\n\t\t\t\trow.basic_rate = dialog.get_value('rate');\n\t\t\t\tfrappe.set_route('Form', doc.doctype, doc.name);\n\t\t\t})\n\t\t});\n}\n"],"names":["frappe","provide","erpnext","stock","ItemDashboard","Class","extend","init","opts","$","this","make","me","handle_move_add","element","action","let","item","unescape","attr","warehouse","actual_qty","Number","entry_type","model","with_doctype","doc","get_new_doc","stock_entry_type","row","add_child","item_code","s_warehouse","set_route","doctype","name","open_stock_entry","rate","move_item","refresh","start","sort_by","sort_order","content","render_template","appendTo","parent","result","find","on","before_refresh","call","method","args","item_group","callback","r","render","message","data","max_count","empty","context","get_item_dashboard_data","length","removeClass","splice","addClass","__","show_item","forEach","d","actual_or_pending","projected_qty","reserved_qty","reserved_qty_for_production","reserved_qty_for_sub_contract","pending_qty","total_reserved","Math","max","can_write","boot","user","indexOf","source","target","dialog","ui","Dialog","title","fields","fieldname","label","fieldtype","options","read_only","reqd","description","hidden","show","get_field","set_input","df","set_value","value","set_primary_action","values","get_values","qty","msgprint","freeze","show_alert","hide","body","from_warehouse","get_value","to_warehouse","f_warehouse","t_warehouse","conversion_factor","transfer_qty","basic_rate"],"mappings":"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"}