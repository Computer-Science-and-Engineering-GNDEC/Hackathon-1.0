!function(){"use strict";frappe.provide("erpnext"),$(document).bind("toolbar_setup",function(){frappe.app.name="ERPNext",frappe.help_feedback_link='<p><a class="text-muted" \t\thref="https://discuss.erpnext.com">Feedback</a></p>',$('[data-link="docs"]').attr("href","https://erpnext.com/docs"),$('[data-link="issues"]').attr("href","https://github.com/frappe/erpnext/issues");var e=$(".dropdown-help ul .documentation-links");$('<li><a data-link-type="forum" href="https://erpnext.com/docs/user/manual" \t\ttarget="_blank">'+__("Documentation")+"</a></li>").insertBefore(e),$('<li><a data-link-type="forum" href="https://discuss.erpnext.com" \t\ttarget="_blank">'+__("User Forum")+"</a></li>").insertBefore(e),$('<li><a href="https://github.com/frappe/erpnext/issues" \t\ttarget="_blank">'+__("Report an Issue")+"</a></li>").insertBefore(e)}),$.extend(frappe.create_routes,{"Customer Group":"Tree/Customer Group",Territory:"Tree/Territory","Item Group":"Tree/Item Group","Sales Person":"Tree/Sales Person",Account:"Tree/Account","Cost Center":"Tree/Cost Center",Department:"Tree/Department"}),$.extend(frappe.breadcrumbs.preferred,{"Item Group":"Stock","Customer Group":"Selling","Supplier Group":"Buying",Territory:"Selling","Sales Person":"Selling","Sales Partner":"Selling",Brand:"Stock"}),$.extend(frappe.breadcrumbs.module_map,{"ERPNext Integrations":"Integrations",Geo:"Settings",Portal:"Website",Utilities:"Settings","Shopping Cart":"Website",Contacts:"CRM"}),frappe.provide("erpnext"),frappe.provide("erpnext.utils"),$.extend(erpnext,{get_currency:function(e){return!e&&cur_frm&&(e=cur_frm.doc.company),e&&frappe.get_doc(":Company",e).default_currency||frappe.boot.sysdefaults.currency},get_presentation_currency_list:function(){var e=frappe.boot.docs.filter(function(e){return":Currency"===e.doctype}).map(function(e){return e.name});return e.unshift(""),e},toggle_naming_series:function(){cur_frm.fields_dict.naming_series&&cur_frm.toggle_display("naming_series",!!cur_frm.doc.__islocal)},hide_company:function(){if(cur_frm.fields_dict.company){var e=Object.keys(locals[":Company"]||{});1===e.length?(cur_frm.doc.company||cur_frm.set_value("company",e[0]),cur_frm.toggle_display("company",!1)):erpnext.last_selected_company&&(cur_frm.doc.company||cur_frm.set_value("company",erpnext.last_selected_company))}},is_perpetual_inventory_enabled:function(e){if(e)return frappe.get_doc(":Company",e).enable_perpetual_inventory},stale_rate_allowed:function(){return cint(frappe.boot.sysdefaults.allow_stale)},setup_serial_no:function(){var e=cur_frm.open_grid_row();if(e&&e.grid_form.fields_dict.serial_no&&"Write"===e.grid_form.fields_dict.serial_no.get_status()){var t=$('<button class="btn btn-sm btn-default">'+__("Add Serial No")+"</button>").appendTo($("<div>").css({"margin-bottom":"10px","margin-top":"10px"}).appendTo(e.grid_form.fields_dict.serial_no.$wrapper)),a=this;t.on("click",function(){frappe.model.get_value("Item",{name:e.doc.item_code},"has_serial_no",function(t){t&&(e.doc.has_serial_no=t.has_serial_no,a.show_serial_batch_selector(e.frm,e.doc,"","",!0))})})}},route_to_adjustment_jv:function(e){frappe.model.with_doctype("Journal Entry",function(){var t=frappe.model.get_new_doc("Journal Entry");e.accounts.forEach(function(e){var a=frappe.model.add_child(t,"accounts");a.account=e.account,a.debit_in_account_currency=e.debit_in_account_currency,a.credit_in_account_currency=e.credit_in_account_currency,a.party_type=""}),frappe.set_route("Form","Journal Entry",t.name)})}}),$.extend(erpnext.utils,{set_party_dashboard_indicators:function(e){if(e.doc.__onload&&e.doc.__onload.dashboard_info){var t=e.doc.__onload.dashboard_info;t.length>1?t.forEach(function(t){erpnext.utils.add_indicator_for_multicompany(e,t)}):1===t.length&&(e.dashboard.add_indicator(__("Annual Billing: {0}",[format_currency(t[0].billing_this_year,t[0].currency)]),"blue"),e.dashboard.add_indicator(__("Total Unpaid: {0}",[format_currency(t[0].total_unpaid,t[0].currency)]),t[0].total_unpaid?"orange":"green"),t[0].loyalty_points&&e.dashboard.add_indicator(__("Loyalty Points: {0}",[t[0].loyalty_points]),"blue"))}},add_indicator_for_multicompany:function(e,t){e.dashboard.stats_area.removeClass("hidden"),e.dashboard.stats_area_row.addClass("flex"),e.dashboard.stats_area_row.css("flex-wrap","wrap");var a=t.total_unpaid?"orange":"green",r=$('<div class="flex-column col-xs-6"><div style="margin-top:10px"><h6>'+t.company+'</h6></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Annual Billing: '+format_currency(t.billing_this_year,t.currency)+'</span></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator '+a+'">Total Unpaid: '+format_currency(t.total_unpaid,t.currency)+"</span></div></div>").appendTo(e.dashboard.stats_area_row);return t.loyalty_points&&$('<div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Loyalty Points: '+t.loyalty_points+"</span></div>").appendTo(r),r},get_party_name:function(e){return{Customer:"customer_name",Supplier:"supplier_name",Employee:"employee_name",Member:"member_name"}[e]},copy_value_in_all_rows:function(e,t,a,r,i){var n=locals[t][a];if(n[i])for(var s=e[r]||[],o=0;o<s.length;o++)s[o][i]||(s[o][i]=n[i]);refresh_field(r)},get_terms:function(e,t,a){if(e)return frappe.call({method:"erpnext.setup.doctype.terms_and_conditions.terms_and_conditions.get_terms_and_conditions",args:{template_name:e,doc:t},callback:function(e){a(e)}})},make_bank_account:function(e,t){frappe.call({method:"erpnext.accounts.doctype.bank_account.bank_account.make_bank_account",args:{doctype:e,docname:t},freeze:!0,callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})},add_dimensions:function(e,t){var a=frappe.query_reports[e].filters;erpnext.dimension_filters.forEach(function(e){a.some(function(t){return t.fieldname===e.fieldname})||a.splice(t,0,{fieldname:e.fieldname,label:__(e.label),fieldtype:"Link",options:e.document_type})})},make_subscription:function(e,t){frappe.call({method:"frappe.automation.doctype.auto_repeat.auto_repeat.make_auto_repeat",args:{doctype:e,docname:t},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})},make_pricing_rule:function(e,t){frappe.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.make_pricing_rule",args:{doctype:e,docname:t},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})},first_row_is_empty:function(e){return!!($.isArray(e)&&e.length>0)&&!e[0].item_code},remove_empty_first_row:function(e,t){var a=e.doc[t];return this.first_row_is_empty(a)&&(e.doc[t]=a.splice(1)),a},get_tree_options:function(e){var t=frappe.model.unscrub(e),a=frappe.defaults.get_user_permissions();return(a&&a[t]?a[t].map(function(e){return e.doc}):$.map(locals[":"+t],function(e){return e.name}).sort()).filter(function(e,t,a){return a.indexOf(e)===t})},get_tree_default:function(e){var t=this.get_tree_options(e);return t.includes(frappe.defaults.get_default(e))?frappe.defaults.get_default(e):t[0]},copy_parent_value_in_all_row:function(e,t,a,r,i,n){if(locals[t][a][i])for(var s=e[r]||[],o=0;o<s.length;o++)s[o][i]=e[n];refresh_field(r)},create_new_doc:function(e,t){frappe.model.with_doctype(e,function(){for(var a=frappe.model.get_new_doc(e),r=0,i=Object.entries(t);r<i.length;r+=1){var n=i[r],s=n[0],o=n[1];a[s]=o}frappe.ui.form.make_quick_entry(e,null,null,a)})}}),erpnext.utils.select_alternate_items=function(e){var t=this,a=e.frm,r=e.warehouse_field||"warehouse",i=e.item_field||"item_code";this.data=[];var n=new frappe.ui.Dialog({title:__("Select Alternate Item"),fields:[{fieldtype:"Section Break",label:__("Items")},{fieldname:"alternative_items",fieldtype:"Table",cannot_add_rows:!0,in_place_edit:!0,data:this.data,get_data:function(){return t.data},fields:[{fieldtype:"Data",fieldname:"docname",hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:1,label:__("Item Code")},{fieldtype:"Link",fieldname:"alternate_item",options:"Item",default:"",in_list_view:1,label:__("Alternate Item"),onchange:function(){var e=this,t=this.get_value(),a=this.grid_row.on_grid_fields_dict.warehouse.get_value();t&&a&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:t,warehouse:a},callback:function(t){e.grid_row.on_grid_fields_dict.actual_qty.set_value(t.message||0)}})},get_query:function(e){return{query:"erpnext.stock.doctype.item_alternative.item_alternative.get_alternative_items",filters:{item_code:e.item_code}}}},{fieldtype:"Link",fieldname:"warehouse",options:"Warehouse",default:"",in_list_view:1,label:__("Warehouse"),onchange:function(){var e=this,t=this.get_value(),a=this.grid_row.on_grid_fields_dict.item_code.get_value();a&&t&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:a,warehouse:t},callback:function(t){e.grid_row.on_grid_fields_dict.actual_qty.set_value(t.message||0)}})}},{fieldtype:"Float",fieldname:"actual_qty",default:0,read_only:1,in_list_view:1,label:__("Available Qty")}]}],primary_action:function(){this.get_values().alternative_items.filter(function(e){if(e.alternate_item&&e.item_code!=e.alternate_item)return!0}).forEach(function(t){var r=frappe.get_doc(e.child_doctype,t.docname),n=null;n="Work Order Item"===r.doctype?r.required_qty:r.qty,r[i]=t.alternate_item,a.script_manager.trigger(i,r.doctype,r.name).then(function(){frappe.model.set_value(r.doctype,r.name,"qty",n),frappe.model.set_value(r.doctype,r.name,e.original_item_field,t.item_code)})}),refresh_field(e.child_docname),this.hide()},primary_action_label:__("Update")});a.doc[e.child_docname].forEach(function(t){e.condition&&!e.condition(t)||n.fields_dict.alternative_items.df.data.push({docname:t.name,item_code:t[i],warehouse:t[r],actual_qty:t.actual_qty})}),this.data=n.fields_dict.alternative_items.df.data,n.fields_dict.alternative_items.grid.refresh(),n.show()},erpnext.utils.update_child_items=function(e){var t=this,a=e.frm,r=void 0===e.cannot_add_row||e.cannot_add_row,i=void 0===e.cannot_add_row?"items":e.child_docname,n=frappe.get_meta(a.doc.doctype+" Item"),s=function(e){return n.fields.find(function(t){return t.fieldname==e}).precision};this.data=[];var o=[{fieldtype:"Data",fieldname:"docname",read_only:1,hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:0,disabled:0,label:__("Item Code")},{fieldtype:"Link",fieldname:"uom",options:"UOM",read_only:0,label:__("UOM"),reqd:1,onchange:function(){var e=this;frappe.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:this.doc.item_code,uom:this.value},callback:function(t){if(!t.exc){if(e.doc.conversion_factor==t.message.conversion_factor)return;var a=e.doc.docname;c.fields_dict.trans_items.df.data.some(function(e){if(e.docname==a)return e.conversion_factor=t.message.conversion_factor,c.fields_dict.trans_items.grid.refresh(),!0})}}})}},{fieldtype:"Float",fieldname:"qty",default:0,read_only:0,in_list_view:1,label:__("Qty"),precision:s("qty")},{fieldtype:"Currency",fieldname:"rate",default:0,read_only:0,in_list_view:1,label:__("Rate"),precision:s("rate")}];"Sales Order"!=a.doc.doctype&&"Purchase Order"!=a.doc.doctype||(o.splice(2,0,{fieldtype:"Date",fieldname:"Sales Order"==a.doc.doctype?"delivery_date":"schedule_date",in_list_view:1,label:"Sales Order"==a.doc.doctype?__("Delivery Date"):__("Reqd by date"),reqd:1}),o.splice(3,0,{fieldtype:"Float",fieldname:"conversion_factor",in_list_view:1,label:__("Conversion Factor"),precision:s("conversion_factor")}));var c=new frappe.ui.Dialog({title:__("Update Items"),fields:[{fieldname:"trans_items",fieldtype:"Table",label:"Items",cannot_add_rows:r,in_place_edit:!0,reqd:1,data:this.data,get_data:function(){return t.data},fields:o}],primary_action:function(){var e=this.get_values().trans_items;frappe.call({method:"erpnext.controllers.accounts_controller.update_child_qty_rate",freeze:!0,args:{parent_doctype:a.doc.doctype,trans_items:e,parent_doctype_name:a.doc.name,child_docname:i},callback:function(){a.reload_doc()}}),this.hide(),refresh_field("items")},primary_action_label:__("Update")});a.doc[e.child_docname].forEach(function(e){c.fields_dict.trans_items.df.data.push({docname:e.name,name:e.name,item_code:e.item_code,delivery_date:e.delivery_date,schedule_date:e.schedule_date,conversion_factor:e.conversion_factor,qty:e.qty,rate:e.rate,uom:e.uom}),t.data=c.fields_dict.trans_items.df.data,c.fields_dict.trans_items.grid.refresh()}),c.show()},erpnext.utils.map_current_doc=function(e){e.get_query_filters&&(e.get_query=function(){return{filters:e.get_query_filters}});var t=function(){if($.isArray(cur_frm.doc.items)&&cur_frm.doc.items.length>0){cur_frm.doc.items[0].item_code||(cur_frm.doc.items=cur_frm.doc.items.splice(1));var t=frappe.meta.get_docfield(cur_frm.doctype,"items").options,a=null;frappe.get_meta(t).fields.forEach(function(t){t.options===e.source_doctype&&(a=t.fieldname)});var r=!1,i={};$.each(cur_frm.doc.items,function(t,n){e.source_name.forEach(function(e){n[a]==e&&(r=!0,i[n.item_code]?i[n.item_code]+=flt(n.qty):i[n.item_code]=flt(n.qty))})}),r&&e.source_name.forEach(function(t){frappe.model.with_doc(e.source_doctype,t,function(a){var n=frappe.model.get_doc(e.source_doctype,t);$.each(n.items||[],function(e,t){if(t.qty>flt(i[t.item_code]))return r=!1,!1})}),r&&frappe.msgprint(__("You have already selected items from {0} {1}",[e.source_doctype,t]))})}return frappe.call({type:"POST",method:"frappe.model.mapper.map_docs",args:{method:e.method,source_names:e.source_name,target_doc:cur_frm.doc,args:e.args},callback:function(e){if(!e.exc){frappe.model.sync(e.message);cur_frm.dirty(),cur_frm.refresh()}}})};if(e.source_doctype)var a=new frappe.ui.form.MultiSelectDialog({doctype:e.source_doctype,target:e.target,date_field:e.date_field||void 0,setters:e.setters,get_query:e.get_query,action:function(r,i){var n=r;0!==n.length?(e.source_name=n,e.setters=i,a.dialog.hide(),t()):frappe.msgprint(__("Please select {0}",[e.source_doctype]))}});else e.source_name&&(e.source_name=[e.source_name],t())},frappe.form.link_formatters.Item=function(e,t){return t&&e&&t.item_name&&t.item_name!==e?e+": "+t.item_name:!e&&t.doctype&&t.item_name?t.item_name:e},frappe.form.link_formatters.Employee=function(e,t){return t&&t.employee_name&&t.employee_name!==e?e?e+": "+t.employee_name:t.employee_name:e},$(document).on("app_ready",function(){frappe.datetime.is_timezone_same()||$.each(["Stock Reconciliation","Stock Entry","Stock Ledger Entry","Delivery Note","Purchase Receipt","Sales Invoice"],function(e,t){frappe.ui.form.on(t,"onload",function(e){cur_frm.set_df_property("posting_time","description",frappe.sys_defaults.time_zone)})})}),frappe.provide("erpnext.queries"),$.extend(erpnext.queries,{user:function(){return{query:"frappe.core.doctype.user.user.user_query"}},lead:function(){return{query:"erpnext.controllers.queries.lead_query"}},customer:function(){return{query:"erpnext.controllers.queries.customer_query"}},supplier:function(){return{query:"erpnext.controllers.queries.supplier_query"}},item:function(e){var t={query:"erpnext.controllers.queries.item_query"};return e&&(t.filters=e),t},bom:function(){return{query:"erpnext.controllers.queries.bom"}},task:function(){return{query:"erpnext.projects.utils.query_task"}},customer_filter:function(e){return e.customer||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(e.doctype,"customer",e.name))])),{filters:{customer:e.customer}}},contact_query:function(e){if(frappe.dynamic_link)return e[frappe.dynamic_link.fieldname]||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(e.doctype,frappe.dynamic_link.fieldname,e.name))])),{query:"frappe.contacts.doctype.contact.contact.contact_query",filters:{link_doctype:frappe.dynamic_link.doctype,link_name:e[frappe.dynamic_link.fieldname]}}},address_query:function(e){if(frappe.dynamic_link)return e[frappe.dynamic_link.fieldname]||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(e.doctype,frappe.dynamic_link.fieldname,e.name))])),{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:frappe.dynamic_link.doctype,link_name:e[frappe.dynamic_link.fieldname]}}},company_address_query:function(e){return{query:"frappe.contacts.doctype.address.address.address_query",filters:{is_your_company_address:1,link_doctype:"Company",link_name:e.company||""}}},supplier_filter:function(e){return e.supplier||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(e.doctype,"supplier",e.name))])),{filters:{supplier:e.supplier}}},lead_filter:function(e){return e.lead||frappe.throw(__("Please specify a {0}",[__(frappe.meta.get_label(e.doctype,"lead",e.name))])),{filters:{lead:e.lead}}},not_a_group_filter:function(){return{filters:{is_group:0}}},employee:function(){return{query:"erpnext.controllers.queries.employee_query"}},warehouse:function(e){return{filters:[["Warehouse","company","in",["",cstr(e.company)]],["Warehouse","is_group","=",0]]}}}),erpnext.queries.setup_queries=function(e,t,a){var r=function(r,i){var n=frappe.meta.get_docfields(r,e.doc.name,{fieldtype:"Link",options:t});$.each(n,function(t,r){i?e.set_query(r.fieldname,i,a):e.set_query(r.fieldname,a)})};r(e.doc.doctype),$.each(frappe.meta.get_docfields(e.doc.doctype,e.doc.name,{fieldtype:"Table"}),function(e,t){r(t.options,t.fieldname)})},erpnext.queries.setup_warehouse_query=function(e){e.set_query("warehouse","items",function(t,a,r){var i=locals[a][r],n=erpnext.queries.warehouse(e.doc);return i.item_code&&($.extend(n,{query:"erpnext.controllers.queries.warehouse_query"}),n.filters.push(["Bin","item_code","=",i.item_code])),n})},erpnext.SMSManager=function(e){var t=this;this.setup=function(){var t={Lead:"",Opportunity:"Your enquiry has been logged into the system. Ref No: "+e.name,Quotation:"Quotation "+e.name+" has been sent via email. Thanks!","Sales Order":"Sales Order "+e.name+" has been created against "+(e.quotation_no?"Quote No:"+e.quotation_no:"")+(e.po_no?" for your PO: "+e.po_no:""),"Delivery Note":"Items has been delivered against delivery note: "+e.name+(e.po_no?" for your PO: "+e.po_no:""),"Sales Invoice":"Invoice "+e.name+" has been sent via email "+(e.po_no?" for your PO: "+e.po_no:""),"Material Request":"Material Request "+e.name+" has been raised in the system","Purchase Order":"Purchase Order "+e.name+" has been sent via email","Purchase Receipt":"Items has been received against purchase receipt: "+e.name};in_list(["Sales Order","Delivery Note","Sales Invoice"],e.doctype)?this.show(e.contact_person,"Customer",e.customer,"",t[e.doctype]):"Quotation"===e.doctype?this.show(e.contact_person,"Customer",e.party_name,"",t[e.doctype]):in_list(["Purchase Order","Purchase Receipt"],e.doctype)?this.show(e.contact_person,"Supplier",e.supplier,"",t[e.doctype]):"Lead"==e.doctype?this.show("","","",e.mobile_no,t[e.doctype]):"Opportunity"==e.doctype?this.show("","","",e.contact_no,t[e.doctype]):"Material Request"==e.doctype&&this.show("","","","",t[e.doctype])},this.get_contact_number=function(e,a,r){frappe.call({method:"frappe.core.doctype.sms_settings.sms_settings.get_contact_number",args:{contact_name:e,ref_doctype:a,ref_name:r},callback:function(e){e.exc?frappe.msgprint(e.exc):(t.number=e.message,t.show_dialog())}})},this.show=function(e,a,r,i,n){this.message=n,i?(t.number=i,t.show_dialog()):e?this.get_contact_number(e,a,r):t.show_dialog()},this.show_dialog=function(){t.dialog||t.make_dialog(),t.dialog.set_values({message:t.message,number:t.number}),t.dialog.show()},this.make_dialog=function(){var e=new frappe.ui.Dialog({title:"Send SMS",width:400,fields:[{fieldname:"number",fieldtype:"Data",label:"Mobile Number",reqd:1},{fieldname:"message",fieldtype:"Text",label:"Message",reqd:1},{fieldname:"send",fieldtype:"Button",label:"Send"}]});e.fields_dict.send.input.onclick=function(){var a=e.fields_dict.send.input,r=t.dialog.get_values();r&&($(a).set_working(),frappe.call({method:"frappe.core.doctype.sms_settings.sms_settings.send_sms",args:{receiver_list:[r.number],msg:r.message},callback:function(e){$(a).done_working(),e.exc?frappe.msgprint(e.exc):t.dialog.hide()}}))},this.dialog=e},this.setup()},frappe.provide("erpnext.utils"),erpnext.utils.get_party_details=function(e,t,a,r){if(t||(t="erpnext.accounts.party.get_party_details"),a&&(in_list(["Sales Invoice","Sales Order","Delivery Note"],e.doc.doctype)&&e.doc.company_address&&!a.company_address&&(a.company_address=e.doc.company_address),in_list(["Purchase Invoice","Purchase Order","Purchase Receipt"],e.doc.doctype)&&e.doc.shipping_address&&!a.shipping_address&&(a.shipping_address=e.doc.shipping_address)),!a){if("Purchase Order"!=e.doctype&&e.doc.customer||e.doc.party_name&&in_list(["Quotation","Opportunity"],e.doc.doctype)){var i="Customer";e.doc.quotation_to&&"Lead"===e.doc.quotation_to&&(i="Lead"),a={party:e.doc.customer||e.doc.party_name,party_type:i,price_list:e.doc.selling_price_list}}else e.doc.supplier&&(a={party:e.doc.supplier,party_type:"Supplier",bill_date:e.doc.bill_date,price_list:e.doc.buying_price_list});in_list(["Sales Invoice","Sales Order","Delivery Note"],e.doc.doctype)&&(a||(a={party:e.doc.customer||e.doc.party_name,party_type:"Customer"}),e.doc.company_address&&!a.company_address&&(a.company_address=e.doc.company_address),e.doc.shipping_address_name&&!a.shipping_address_name&&(a.shipping_address_name=e.doc.shipping_address_name)),in_list(["Purchase Invoice","Purchase Order","Purchase Receipt"],e.doc.doctype)&&(a||(a={party:e.doc.supplier,party_type:"Supplier"}),e.doc.shipping_address&&!a.shipping_address&&(a.shipping_address=e.doc.shipping_address)),a&&(a.posting_date=e.doc.posting_date||e.doc.transaction_date)}a&&a.party&&(frappe.meta.get_docfield(e.doc.doctype,"taxes")&&!erpnext.utils.validate_mandatory(e,"Posting / Transaction Date",a.posting_date,"Customer"==a.party_type?"customer":"supplier")||erpnext.utils.validate_mandatory(e,"Company",e.doc.company,"Customer"==a.party_type?"customer":"supplier")&&(a.currency=e.doc.currency,a.company=e.doc.company,a.doctype=e.doc.doctype,frappe.call({method:t,args:a,callback:function(t){t.message&&(e.supplier_tds=t.message.supplier_tds,e.updating_party_details=!0,frappe.run_serially([function(){return e.set_value(t.message)},function(){e.updating_party_details=!1,r&&r(),e.refresh(),erpnext.utils.add_item(e)}]))}})))},erpnext.utils.add_item=function(e){if(e.is_new()){var t=frappe.get_prev_route();if(!("Item"!==t[1]||e.doc.items&&e.doc.items.length)){var a=e.add_child("items");e.refresh_field("items"),frappe.model.set_value(a.doctype,a.name,"item_code",t[2])}}},erpnext.utils.get_address_display=function(e,t,a,r){if(!e.updating_party_details){if(!t)if("Purchase Order"!=e.doctype&&e.doc.customer)t="customer_address";else{if(!e.doc.supplier)return;t="supplier_address"}a||(a="address_display"),e.doc[t]?frappe.call({method:"frappe.contacts.doctype.address.address.get_address_display",args:{address_dict:e.doc[t]},callback:function(t){t.message&&e.set_value(a,t.message)}}):e.set_value(a,"")}},erpnext.utils.set_taxes_from_address=function(e,t,a,r){e.updating_party_details||frappe.meta.get_docfield(e.doc.doctype,"taxes")&&erpnext.utils.validate_mandatory(e,"Lead / Customer / Supplier",e.doc.customer||e.doc.supplier||e.doc.lead||e.doc.party_name,t)&&erpnext.utils.validate_mandatory(e,"Posting / Transaction Date",e.doc.posting_date||e.doc.transaction_date,t)&&frappe.call({method:"erpnext.accounts.party.get_address_tax_category",args:{tax_category:e.doc.tax_category,billing_address:e.doc[a],shipping_address:e.doc[r]},callback:function(a){a.exc||(e.doc.tax_category!=a.message?e.set_value("tax_category",a.message):erpnext.utils.set_taxes(e,t))}})},erpnext.utils.set_taxes=function(e,t){var a,r;frappe.meta.get_docfield(e.doc.doctype,"taxes")&&(erpnext.utils.validate_mandatory(e,"Company",e.doc.company,t)&&erpnext.utils.validate_mandatory(e,"Lead / Customer / Supplier",e.doc.customer||e.doc.supplier||e.doc.lead||e.doc.party_name,t)&&erpnext.utils.validate_mandatory(e,"Posting / Transaction Date",e.doc.posting_date||e.doc.transaction_date,t)&&(e.doc.lead?(a="Lead",r=e.doc.lead):e.doc.customer?(a="Customer",r=e.doc.customer):e.doc.supplier?(a="Supplier",r=e.doc.supplier):e.doc.quotation_to&&(a=e.doc.quotation_to,r=e.doc.party_name),e.doc.company||frappe.throw(_("Kindly select the company first")),frappe.call({method:"erpnext.accounts.party.set_taxes",args:{party:r,party_type:a,posting_date:e.doc.posting_date||e.doc.transaction_date,company:e.doc.company,customer_group:e.doc.customer_group,supplier_group:e.doc.supplier_group,tax_category:e.doc.tax_category,billing_address:e.doc.customer||e.doc.lead?e.doc.customer_address:e.doc.supplier_address,shipping_address:e.doc.shipping_address_name},callback:function(t){t.message&&e.set_value("taxes_and_charges",t.message)}})))},erpnext.utils.get_contact_details=function(e){e.updating_party_details||e.doc.contact_person&&frappe.call({method:"frappe.contacts.doctype.contact.contact.get_contact_details",args:{contact:e.doc.contact_person},callback:function(t){t.message&&e.set_value(t.message)}})},erpnext.utils.validate_mandatory=function(e,t,a,r){return!!a||(e.doc[r]="",refresh_field(r),frappe.throw({message:__("Please enter {0} first",[t]),title:__("Mandatory")}),!1)},erpnext.utils.get_shipping_address=function(e,t){e.doc.company?frappe.call({method:"frappe.contacts.doctype.address.address.get_shipping_address",args:{company:e.doc.company,address:e.doc.shipping_address},callback:function(a){if(a.message&&(e.set_value("shipping_address",a.message[0]),e.set_value("shipping_address_display",a.message[1])),t)return t()}}):frappe.msgprint(__("Select company first"))},frappe.templates.address_list='<div class="clearfix"></div> {% for(var i=0, l=addr_list.length; i<l; i++) { %}     <div class="address-box">     <p class="h6">         {%= i+1 %}. {%= addr_list[i].address_type!="Other" ? __(addr_list[i].address_type) : addr_list[i].address_title %}         {% if(addr_list[i].is_primary_address) { %}             <span class="text-muted">({%= __("Primary") %})</span>{% } %}         {% if(addr_list[i].is_shipping_address) { %}             <span class="text-muted">({%= __("Shipping") %})</span>{% } %}          <a href="#Form/Address/{%= encodeURIComponent(addr_list[i].name) %}"             class="btn btn-default btn-xs pull-right"     style="margin-top:-3px; margin-right: -5px;">             {%= __("Edit") %}</a>     </p>         <p>{%= addr_list[i].display %}</p>     </div> {% } %} {% if(!addr_list.length) { %} <p class="text-muted small">{%= __("No address added yet.") %}</p> {% } %} <p><button class="btn btn-xs btn-default btn-address">{{ __("New Address") }}</button></p>  ',frappe.templates.contact_list='<div class="clearfix"></div> {% for(var i=0, l=contact_list.length; i<l; i++) { %}  <div class="address-box">   <p class="h6">    {%= contact_list[i].first_name %} {%= contact_list[i].last_name %}    {% if(contact_list[i].is_primary_contact) { %}     <span class="text-muted">({%= __("Primary") %})</span>    {% } %}    {% if(contact_list[i].designation){ %}     <span class="text-muted">&ndash; {%= contact_list[i].designation %}</span>    {% } %}    <a href="#Form/Contact/{%= encodeURIComponent(contact_list[i].name) %}"     class="btn btn-xs btn-default pull-right"     style="margin-top:-3px; margin-right: -5px;">     {%= __("Edit") %}</a>   </p>   {% if (contact_list[i].phones || contact_list[i].email_ids) { %}   <p>    {% if(contact_list[i].phone) { %}     {%= __("Phone") %}: {%= contact_list[i].phone %}<span class="text-muted"> ({%= __("Primary") %})</span><br>    {% endif %}    {% if(contact_list[i].mobile_no) { %}     {%= __("Mobile No") %}: {%= contact_list[i].mobile_no %}<span class="text-muted"> ({%= __("Primary") %})</span><br>    {% endif %}    {% if(contact_list[i].phone_nos) { %}     {% for(var j=0, k=contact_list[i].phone_nos.length; j<k; j++) { %}      {%= __("Phone") %}: {%= contact_list[i].phone_nos[j].phone %}<br>     {% } %}    {% endif %}   </p>   <p>    {% if(contact_list[i].email_id) { %}     {%= __("Email") %}: {%= contact_list[i].email_id %}<span class="text-muted"> ({%= __("Primary") %})</span><br>    {% endif %}    {% if(contact_list[i].email_ids) { %}     {% for(var j=0, k=contact_list[i].email_ids.length; j<k; j++) { %}      {%= __("Email") %}: {%= contact_list[i].email_ids[j].email_id %}<br>     {% } %}    {% endif %}   </p>   {% endif %}   <p>   {% if (contact_list[i].address) { %}    {%= __("Address") %}: {%= contact_list[i].address %}<br>   {% endif %}   </p>  </div> {% } %} {% if(!contact_list.length) { %} <p class="text-muted small">{%= __("No contacts added yet.") %}</p> {% } %} <p><button class="btn btn-xs btn-default btn-contact">  {{ __("New Contact") }}</button> </p>',frappe.provide("erpnext.stock"),erpnext.stock.StockController=frappe.ui.form.Controller.extend({onload:function(){this.frm.fields_dict.company&&this.setup_warehouse_query()},setup_warehouse_query:function(){var e=this;erpnext.queries.setup_queries(this.frm,"Warehouse",function(){return erpnext.queries.warehouse(e.frm.doc)})},setup_posting_date_time_check:function(){frappe.ui.form.on(this.frm.doctype,"set_posting_date_and_time_read_only",function(e){0==e.doc.docstatus&&e.doc.set_posting_time?(e.set_df_property("posting_date","read_only",0),e.set_df_property("posting_time","read_only",0)):(e.set_df_property("posting_date","read_only",1),e.set_df_property("posting_time","read_only",1))}),frappe.ui.form.on(this.frm.doctype,"set_posting_time",function(e){e.trigger("set_posting_date_and_time_read_only")}),frappe.ui.form.on(this.frm.doctype,"refresh",function(e){0==e.doc.docstatus&&(e.doc.posting_date||e.set_value("posting_date",frappe.datetime.nowdate()),e.doc.posting_time||e.set_value("posting_time",frappe.datetime.now_time()),e.trigger("set_posting_date_and_time_read_only"))})},show_stock_ledger:function(){var e=this;1===this.frm.doc.docstatus&&cur_frm.add_custom_button(__("Stock Ledger"),function(){frappe.route_options={voucher_no:e.frm.doc.name,from_date:e.frm.doc.posting_date,to_date:e.frm.doc.posting_date,company:e.frm.doc.company},frappe.set_route("query-report","Stock Ledger")},__("View"))},show_general_ledger:function(){var e=this;1===this.frm.doc.docstatus&&cur_frm.add_custom_button(__("Accounting Ledger"),function(){frappe.route_options={voucher_no:e.frm.doc.name,from_date:e.frm.doc.posting_date,to_date:e.frm.doc.posting_date,company:e.frm.doc.company,group_by:"Group by Voucher (Consolidated)"},frappe.set_route("query-report","General Ledger")},__("View"))}}),erpnext.payments=erpnext.stock.StockController.extend({make_payment:function(){this.dialog=new frappe.ui.Dialog({title:"Payment"}),this.dialog.show(),this.$body=this.dialog.body,this.set_payment_primary_action(),this.make_keyboard(),this.select_text()},select_text:function(){$(this.$body).find(".form-control").click(function(){$(this).select()})},set_payment_primary_action:function(){var e=this;this.dialog.set_primary_action(__("Submit"),function(){$.each(e.frm.doc.payments,function(t,a){if(0!=a.amount)return e.dialog.hide(),void e.submit_invoice()})})},make_keyboard:function(){$(this.$body).empty(),$(this.$body).html(frappe.render_template("pos_payment",this.frm.doc)),this.show_payment_details(),this.bind_keyboard_event(),this.clear_amount()},make_multimode_payment:function(){this.frm.doc.change_amount>0&&(this.payment_val=this.doc.outstanding_amount),this.payments=frappe.model.add_child(this.frm.doc,"Multi Mode Payment","payments"),this.payments.mode_of_payment=this.dialog.fields_dict.mode_of_payment.get_value(),this.payments.amount=flt(this.payment_val)},show_payment_details:function(){var e=this,t=$(this.$body).find(".multimode-payments").empty();this.frm.doc.payments.length?$.each(this.frm.doc.payments,function(a,r){$(frappe.render_template("payment_details",{mode_of_payment:r.mode_of_payment,amount:r.amount,idx:r.idx,currency:e.frm.doc.currency,type:r.type})).appendTo(t),"Cash"==r.type&&r.amount==e.frm.doc.paid_amount&&(e.idx=r.idx,e.selected_mode=$(e.$body).find(repl("input[idx='%(idx)s']",{idx:e.idx})),e.highlight_selected_row(),e.bind_amount_change_event())}):$("<p>No payment mode selected in pos profile</p>").appendTo(t)},set_outstanding_amount:function(){this.selected_mode=$(this.$body).find(repl("input[idx='%(idx)s']",{idx:this.idx})),this.highlight_selected_row(),this.payment_val=0,this.frm.doc.outstanding_amount>0&&0==flt(this.selected_mode.val())?(this.payment_val=flt(this.frm.doc.outstanding_amount/this.frm.doc.conversion_rate,precision("outstanding_amount")),this.selected_mode.val(format_currency(this.payment_val,this.frm.doc.currency)),this.update_payment_amount()):flt(this.selected_mode.val())>0&&(this.payment_val=flt(this.selected_mode.val())),this.selected_mode.select(),this.bind_amount_change_event()},bind_keyboard_event:function(){this.payment_val="",this.bind_form_control_event(),this.bind_numeric_keys_event()},bind_form_control_event:function(){var e=this;$(this.$body).find(".pos-payment-row").click(function(){e.idx=$(this).attr("idx"),e.set_outstanding_amount()}),$(this.$body).find(".form-control").click(function(){e.idx=$(this).attr("idx"),e.set_outstanding_amount(),e.update_paid_amount(!0)}),$(this.$body).find(".write_off_amount").change(function(){e.write_off_amount(flt($(this).val()),precision("write_off_amount"))}),$(this.$body).find(".change_amount").change(function(){e.change_amount(flt($(this).val()),precision("change_amount"))})},highlight_selected_row:function(){var e=$(this.$body).find(repl(".pos-payment-row[idx='%(idx)s']",{idx:this.idx}));$(this.$body).find(".pos-payment-row").removeClass("selected-payment-mode"),e.addClass("selected-payment-mode"),$(this.$body).find(".amount").attr("disabled",!0),this.selected_mode.attr("disabled",!1)},bind_numeric_keys_event:function(){var e=this;$(this.$body).find(".pos-keyboard-key").click(function(){e.payment_val+=$(this).text(),e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_paid_amount()}),$(this.$body).find(".delete-btn").click(function(){e.payment_val=cstr(flt(e.selected_mode.val())).slice(0,-1),e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_paid_amount()})},bind_amount_change_event:function(){var e=this;this.selected_mode.change(function(){e.payment_val=flt($(this).val())||0,e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_payment_amount()})},clear_amount:function(){var e=this;$(this.$body).find(".clr").click(function(t){t.stopPropagation(),e.idx=$(this).attr("idx"),e.selected_mode=$(e.$body).find(repl("input[idx='%(idx)s']",{idx:e.idx})),e.payment_val=0,e.selected_mode.val(0),e.highlight_selected_row(),e.update_payment_amount()})},write_off_amount:function(e){this.frm.doc.write_off_amount=flt(e,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount")),this.calculate_outstanding_amount(!1),this.show_amounts()},change_amount:function(e){this.frm.doc.change_amount=flt(e,precision("change_amount")),this.calculate_write_off_amount(),this.show_amounts()},update_paid_amount:function(e){var t=this;if(in_list(["change_amount","write_off_amount"],this.idx)){var a=t.selected_mode.val();"change_amount"==t.idx?t.change_amount(a):(0==flt(a)&&e&&t.frm.doc.outstanding_amount>0&&(a=flt(t.frm.doc.outstanding_amount/t.frm.doc.conversion_rate,precision(t.idx))),t.write_off_amount(a))}else this.update_payment_amount()},update_payment_amount:function(){var e=this;$.each(this.frm.doc.payments,function(t,a){cint(e.idx)==cint(a.idx)&&(a.amount=flt(e.selected_mode.val(),2))}),this.calculate_outstanding_amount(!1),this.show_amounts()},show_amounts:function(){$(this.$body).find(".write_off_amount").val(format_currency(this.frm.doc.write_off_amount,this.frm.doc.currency)),$(this.$body).find(".paid_amount").text(format_currency(this.frm.doc.paid_amount,this.frm.doc.currency)),$(this.$body).find(".change_amount").val(format_currency(this.frm.doc.change_amount,this.frm.doc.currency)),$(this.$body).find(".outstanding_amount").text(format_currency(this.frm.doc.outstanding_amount,frappe.get_doc(":Company",this.frm.doc.company).default_currency)),this.update_invoice()}}),erpnext.taxes_and_totals=erpnext.payments.extend({setup:function(){},apply_pricing_rule_on_item:function(e){var t=e.price_list_rate;"Sales Order"===e.parenttype&&e.blanket_order_rate&&(t=e.blanket_order_rate),"Percentage"==e.margin_type?e.rate_with_margin=flt(t)+flt(t)*(flt(e.margin_rate_or_amount)/100):e.rate_with_margin=flt(t)+flt(e.margin_rate_or_amount),e.base_rate_with_margin=flt(e.rate_with_margin)*flt(this.frm.doc.conversion_rate),e.rate=flt(e.rate_with_margin,precision("rate",e)),e.discount_percentage&&(e.discount_amount=flt(e.rate_with_margin)*flt(e.discount_percentage)/100),e.discount_amount&&(e.rate=flt(e.rate_with_margin-e.discount_amount,precision("rate",e)),e.discount_percentage=100*flt(e.discount_amount)/flt(e.rate_with_margin))},calculate_taxes_and_totals:function(e){this.discount_amount_applied=!1,this._calculate_taxes_and_totals(),this.calculate_discount_amount(),in_list(["Sales Invoice","Purchase Invoice"],this.frm.doc.doctype)&&this.frm.doc.docstatus<2&&!this.frm.doc.is_return&&this.calculate_total_advance(e),"Sales Invoice"==this.frm.doc.doctype&&this.frm.doc.is_pos&&this.frm.doc.is_return&&this.update_paid_amount_for_return(),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice"],this.frm.doc.doctype)&&(this.calculate_commission(),this.calculate_contribution()),"Purchase Invoice"===this.frm.doc.doctype&&this.frm.doc.is_return&&this.frm.doc.grand_total>this.frm.doc.paid_amount&&(this.frm.doc.paid_amount=flt(this.frm.doc.grand_total,precision("grand_total"))),this.frm.refresh_fields()},calculate_discount_amount:function(){frappe.meta.get_docfield(this.frm.doc.doctype,"discount_amount")&&(this.set_discount_amount(),this.apply_discount_amount())},_calculate_taxes_and_totals:function(){this.validate_conversion_rate(),this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_taxes(),this.manipulate_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()},validate_conversion_rate:function(){this.frm.doc.conversion_rate=flt(this.frm.doc.conversion_rate,cur_frm?precision("conversion_rate"):9);var e=frappe.meta.get_label(this.frm.doc.doctype,"conversion_rate",this.frm.doc.name),t=this.get_company_currency();if(!this.frm.doc.conversion_rate)if(this.frm.doc.currency==t)this.frm.set_value("conversion_rate",1);else{var a=__("{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}",[e,this.frm.doc.currency,t]);frappe.throw(a)}},calculate_item_values:function(){var e=this;this.discount_amount_applied||$.each(this.frm.doc.items||[],function(t,a){frappe.model.round_floats_in(a),a.net_rate=a.rate,!a.qty&&e.frm.doc.is_return?a.amount=flt(-1*a.rate,precision("amount",a)):a.amount=flt(a.rate*a.qty,precision("amount",a)),a.net_amount=a.amount,a.item_tax_amount=0,a.total_weight=flt(a.weight_per_unit*a.stock_qty),e.set_in_company_currency(a,["price_list_rate","rate","amount","net_rate","net_amount"])})},set_in_company_currency:function(e,t){var a=this;$.each(t,function(t,r){e["base_"+r]=flt(flt(e[r],precision(r,e))*a.frm.doc.conversion_rate,precision("base_"+r,e))})},initialize_taxes:function(){var e=this;$.each(this.frm.doc.taxes||[],function(t,a){a.item_wise_tax_detail={};var r=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];"Actual"==cstr(a.charge_type)||e.discount_amount_applied&&"Grand Total"==e.frm.doc.apply_discount_on||r.push("tax_amount"),$.each(r,function(e,t){a[t]=0}),!this.discount_amount_applied&&cur_frm&&(cur_frm.cscript.validate_taxes_and_charges(a.doctype,a.name),e.validate_inclusive_tax(a)),frappe.model.round_floats_in(a)})},determine_exclusive_rate:function(){var e=this,t=!1;$.each(e.frm.doc.taxes||[],function(e,a){cint(a.included_in_print_rate)&&(t=!0)}),0!=t&&$.each(e.frm.doc.items||[],function(t,a){var r=e._load_item_tax_rate(a.item_tax_rate),i=0,n=0;if($.each(e.frm.doc.taxes||[],function(t,s){var o=e.get_current_tax_fraction(s,r);s.tax_fraction_for_current_item=o[0];var c=o[1];s.grand_total_fraction_for_current_item=0==t?1+s.tax_fraction_for_current_item:e.frm.doc.taxes[t-1].grand_total_fraction_for_current_item+s.tax_fraction_for_current_item,i+=s.tax_fraction_for_current_item,n+=c*flt(a.qty)}),!e.discount_amount_applied&&a.qty&&(n||i)){var s=flt(a.amount)-n;a.net_amount=flt(s/(1+i)),a.net_rate=a.qty?flt(a.net_amount/a.qty,precision("net_rate",a)):0,e.set_in_company_currency(a,["net_rate","net_amount"])}})},get_current_tax_fraction:function(e,t){var a=0,r=0;if(cint(e.included_in_print_rate)){var i=this._get_tax_rate(e,t);"On Net Total"==e.charge_type?a=i/100:"On Previous Row Amount"==e.charge_type?a=i/100*this.frm.doc.taxes[cint(e.row_id)-1].tax_fraction_for_current_item:"On Previous Row Total"==e.charge_type?a=i/100*this.frm.doc.taxes[cint(e.row_id)-1].grand_total_fraction_for_current_item:"On Item Quantity"==e.charge_type&&(r=flt(i))}return e.add_deduct_tax&&"Deduct"==e.add_deduct_tax&&(a*=-1,r*=-1),[a,r]},_get_tax_rate:function(e,t){return-1!=Object.keys(t).indexOf(e.account_head)?flt(t[e.account_head],precision("rate",e)):e.rate},calculate_net_total:function(){var e=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=0,$.each(this.frm.doc.items||[],function(t,a){e.frm.doc.total+=a.amount,e.frm.doc.total_qty+=a.qty,e.frm.doc.base_total+=a.base_amount,e.frm.doc.net_total+=a.net_amount,e.frm.doc.base_net_total+=a.base_net_amount}),frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"])},calculate_taxes:function(){var e=this;this.frm.doc.rounding_adjustment=0;var t={};$.each(this.frm.doc.taxes||[],function(e,a){"Actual"==a.charge_type&&(t[a.idx]=flt(a.tax_amount,precision("tax_amount",a)))}),$.each(this.frm.doc.items||[],function(a,r){var i=e._load_item_tax_rate(r.item_tax_rate);$.each(e.frm.doc.taxes||[],function(n,s){var o=e.get_current_tax_amount(r,s,i);"Actual"==s.charge_type&&(t[s.idx]-=o,a==e.frm.doc.items.length-1&&(o+=t[s.idx])),"Actual"==s.charge_type||e.discount_amount_applied&&"Grand Total"==e.frm.doc.apply_discount_on||(s.tax_amount+=o),s.tax_amount_for_current_item=o,s.tax_amount_after_discount_amount+=o,s.category&&(o="Valuation"==s.category?0:o,o*="Deduct"==s.add_deduct_tax?-1:1),s.grand_total_for_current_item=0==n?flt(r.net_amount+o):flt(e.frm.doc.taxes[n-1].grand_total_for_current_item+o),a==e.frm.doc.items.length-1&&(e.round_off_totals(s),e.set_cumulative_total(n,s),e.set_in_company_currency(s,["total","tax_amount","tax_amount_after_discount_amount"]),n==e.frm.doc.taxes.length-1&&e.discount_amount_applied&&"Grand Total"==e.frm.doc.apply_discount_on&&e.frm.doc.discount_amount&&(e.frm.doc.rounding_adjustment=flt(e.frm.doc.grand_total-flt(e.frm.doc.discount_amount)-s.total,precision("rounding_adjustment"))))})})},set_cumulative_total:function(e,t){var a=t.tax_amount_after_discount_amount;"Valuation"==t.category&&(a=0),"Deduct"==t.add_deduct_tax&&(a*=-1),t.total=0==e?flt(this.frm.doc.net_total+a,precision("total",t)):flt(this.frm.doc.taxes[e-1].total+a,precision("total",t))},_load_item_tax_rate:function(e){return e?JSON.parse(e):{}},get_current_tax_amount:function(e,t,a){var r=this._get_tax_rate(t,a),i=0;if(["On Previous Row Amount","On Previous Row Total"].includes(t.charge_type)&&(1===t.idx&&frappe.throw(__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row")),t.row_id||(t.row_id=t.idx-1)),"Actual"==t.charge_type){var n=flt(t.tax_amount,precision("tax_amount",t));i=this.frm.doc.net_total?e.net_amount/this.frm.doc.net_total*n:0}else"On Net Total"==t.charge_type?i=r/100*e.net_amount:"On Previous Row Amount"==t.charge_type?i=r/100*this.frm.doc.taxes[cint(t.row_id)-1].tax_amount_for_current_item:"On Previous Row Total"==t.charge_type?i=r/100*this.frm.doc.taxes[cint(t.row_id)-1].grand_total_for_current_item:"On Item Quantity"==t.charge_type&&(i=r*e.qty);return this.set_item_wise_tax(e,t,r,i),i},set_item_wise_tax:function(e,t,a,r){var i=t.item_wise_tax_detail,n=e.item_code||e.item_name,s=r*this.frm.doc.conversion_rate;i&&i[n]&&(s+=i[n][1]),i[n]=[a,flt(s,precision("base_tax_amount",t))]},round_off_totals:function(e){e.tax_amount=flt(e.tax_amount,precision("tax_amount",e)),e.tax_amount_after_discount_amount=flt(e.tax_amount_after_discount_amount,precision("tax_amount",e))},manipulate_grand_total_for_inclusive_tax:function(){var e=this;if(this.frm.doc.taxes&&this.frm.doc.taxes.length){var t=!1;if($.each(this.frm.doc.taxes||[],function(e,a){cint(a.included_in_print_rate)&&(t=!0)}),t){var a=e.frm.doc.taxes.slice(-1)[0],r=frappe.utils.sum($.map(this.frm.doc.taxes||[],function(e){if(!e.included_in_print_rate)return flt(e.tax_amount_after_discount_amount)})),i=e.frm.doc.total+r-flt(a.total,precision("grand_total"));e.discount_amount_applied&&e.frm.doc.discount_amount&&(i-=flt(e.frm.doc.discount_amount)),(i=flt(i,precision("rounding_adjustment")))&&Math.abs(i)<=5/Math.pow(10,precision("tax_amount",a))&&(e.frm.doc.rounding_adjustment=i)}}},calculate_totals:function(){var e=this,t=this.frm.doc.taxes?this.frm.doc.taxes.length:0;this.frm.doc.grand_total=flt(t?this.frm.doc.taxes[t-1].total+flt(this.frm.doc.rounding_adjustment):this.frm.doc.net_total),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice"],this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,t&&($.each(this.frm.doc.taxes||[],function(t,a){in_list(["Valuation and Total","Total"],a.category)&&("Add"==a.add_deduct_tax?e.frm.doc.taxes_and_charges_added+=flt(a.tax_amount_after_discount_amount):e.frm.doc.taxes_and_charges_deducted+=flt(a.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()},set_rounded_total:function(){var e=0;if(frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total",this.frm.doc.name)?e=this.frm.doc.disable_rounded_total:frappe.sys_defaults.disable_rounded_total&&(e=frappe.sys_defaults.disable_rounded_total),cint(e))return this.frm.doc.rounded_total=0,void(this.frm.doc.base_rounded_total=0);frappe.meta.get_docfield(this.frm.doc.doctype,"rounded_total",this.frm.doc.name)&&(this.frm.doc.rounded_total=round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,this.frm.doc.currency,precision("rounded_total")),this.frm.doc.rounding_adjustment+=flt(this.frm.doc.rounded_total-this.frm.doc.grand_total,precision("rounding_adjustment")),this.set_in_company_currency(this.frm.doc,["rounding_adjustment","rounded_total"]))},_cleanup:function(){if(this.frm.doc.base_in_words=this.frm.doc.in_words="",this.frm.doc.items&&this.frm.doc.items.length&&(frappe.meta.get_docfield(this.frm.doc.items[0].doctype,"item_tax_amount",this.frm.doctype)||$.each(this.frm.doc.items||[],function(e,t){delete t.item_tax_amount})),this.frm.doc.taxes&&this.frm.doc.taxes.length){var e=["tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];frappe.meta.get_docfield(this.frm.doc.taxes[0].doctype,"tax_amount_after_discount_amount",this.frm.doctype)||e.push("tax_amount_after_discount_amount"),$.each(this.frm.doc.taxes||[],function(t,a){$.each(e,function(e,t){delete a[t]}),a.item_wise_tax_detail=JSON.stringify(a.item_wise_tax_detail)})}},set_discount_amount:function(){this.frm.doc.additional_discount_percentage&&(this.frm.doc.discount_amount=flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])*this.frm.doc.additional_discount_percentage/100,precision("discount_amount")))},apply_discount_amount:function(){var e=this,t=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount"));var a=this.get_total_for_discount_amount(),r=0;a&&($.each(this.frm.doc.items||[],function(i,n){if(t=flt(e.frm.doc.discount_amount)*n.net_amount/a,n.net_amount=flt(n.net_amount-t,precision("base_amount",n)),r+=n.net_amount,(!(e.frm.doc.taxes||[]).length||a==e.frm.doc.net_total||"Net Total"==e.frm.doc.apply_discount_on)&&i==(e.frm.doc.items||[]).length-1){var s=flt(e.frm.doc.net_total-r-e.frm.doc.discount_amount,precision("net_total"));n.net_amount=flt(n.net_amount+s,precision("net_amount",n))}n.net_rate=n.qty?flt(n.net_amount/n.qty,precision("net_rate",n)):0,e.set_in_company_currency(n,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}},get_total_for_discount_amount:function(){if("Net Total"==this.frm.doc.apply_discount_on)return this.frm.doc.net_total;var e=0,t={};return $.each(this.frm.doc.taxes||[],function(e,a){if(in_list(["Actual","On Item Quantity"],a.charge_type)){var r="Valuation"==a.category?0:a.tax_amount;r*="Deduct"==a.add_deduct_tax?-1:1,t[a.idx]=r}else if(null!==t[a.row_id]){var i=flt(t[a.row_id])*flt(a.rate)/100;t[a.idx]=i}}),$.each(t,function(t,a){a&&(e+=a)}),flt(this.frm.doc.grand_total-e,precision("grand_total"))},calculate_total_advance:function(e){var t=frappe.utils.sum($.map(this.frm.doc.advances||[],function(e){return flt(e.allocated_amount,precision("allocated_amount",e))}));this.frm.doc.total_advance=flt(t,precision("total_advance")),this.calculate_outstanding_amount(e)},calculate_outstanding_amount:function(e){if("Sales Invoice"==this.frm.doc.doctype&&this.frm.doc.is_return&&this.calculate_paid_amount(),!(this.frm.doc.is_return||this.frm.doc.docstatus>0)&&(frappe.model.round_floats_in(this.frm.doc,["grand_total","total_advance","write_off_amount"]),in_list(["Sales Invoice","Purchase Invoice"],this.frm.doc.doctype))){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var a=flt(t-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else a=flt(flt(t*this.frm.doc.conversion_rate,precision("grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));if(frappe.model.round_floats_in(this.frm.doc,["paid_amount"]),this.set_in_company_currency(this.frm.doc,["paid_amount"]),this.frm.refresh_field&&(this.frm.refresh_field("paid_amount"),this.frm.refresh_field("base_paid_amount")),"Sales Invoice"==this.frm.doc.doctype){var r=this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount?flt(a-this.frm.doc.loyalty_amount,precision("base_grand_total")):a;this.set_default_payment(r,e),this.calculate_paid_amount()}this.calculate_change_amount();var i=this.frm.doc.party_account_currency==this.frm.doc.currency?this.frm.doc.paid_amount:this.frm.doc.base_paid_amount;this.frm.doc.outstanding_amount=flt(a-flt(i)+flt(this.frm.doc.change_amount*this.frm.doc.conversion_rate),precision("outstanding_amount"))}},update_paid_amount_for_return:function(){var e=this,t=this.frm.doc.rounded_total||this.frm.doc.grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var a=flt(t-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else a=flt(flt(t*this.frm.doc.conversion_rate,precision("grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));var r=0;$.each(this.frm.doc.payments||[],function(e,t){r+=t.amount}),r!=a?frappe.db.get_value("Sales Invoice Payment",{parent:this.frm.doc.pos_profile,default:1},["mode_of_payment","account","type"],function(t){if(e.frm.is_dirty()){if(frappe.model.clear_table(e.frm.doc,"payments"),t){var r=frappe.model.add_child(e.frm.doc,"Sales Invoice Payment","payments");r.mode_of_payment=t.mode_of_payment,r.type=t.type,r.account=t.account,r.default=1,r.amount=a}else e.frm.set_value("is_pos",1);e.frm.refresh_fields(),e.calculate_paid_amount()}},"Sales Invoice"):this.calculate_paid_amount()},set_default_payment:function(e,t){var a=this,r=!0;this.frm.doc.is_pos&&(void 0===t||t)&&$.each(this.frm.doc.payments||[],function(t,i){i.default&&r&&e>0?(i.base_amount=flt(e,precision("base_amount")),i.amount=flt(e/a.frm.doc.conversion_rate,precision("amount")),r=!1):a.frm.doc.paid_amount&&(i.amount=0)})},calculate_paid_amount:function(){var e=this,t=0,a=0;this.frm.doc.is_pos?$.each(this.frm.doc.payments||[],function(r,i){i.base_amount=flt(i.amount*e.frm.doc.conversion_rate,precision("base_amount")),t+=i.amount,a+=i.base_amount}):this.frm.doc.is_return||(this.frm.doc.payments=[]),this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount&&(a+=this.frm.doc.loyalty_amount,t+=flt(this.frm.doc.loyalty_amount/e.frm.doc.conversion_rate,precision("paid_amount"))),this.frm.doc.paid_amount=flt(t,precision("paid_amount")),this.frm.doc.base_paid_amount=flt(a,precision("base_paid_amount"))},calculate_change_amount:function(){if(this.frm.doc.change_amount=0,this.frm.doc.base_change_amount=0,"Sales Invoice"==this.frm.doc.doctype&&this.frm.doc.paid_amount>this.frm.doc.grand_total&&!this.frm.doc.is_return){var e=$.map(this.frm.doc.payments,function(e){return e.type});if(in_list(e,"Cash")){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total,a=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;this.frm.doc.change_amount=flt(this.frm.doc.paid_amount-t+this.frm.doc.write_off_amount,precision("change_amount")),this.frm.doc.base_change_amount=flt(this.frm.doc.base_paid_amount-a+this.frm.doc.base_write_off_amount,precision("base_change_amount"))}}},calculate_write_off_amount:function(){this.frm.doc.paid_amount>this.frm.doc.grand_total?(this.frm.doc.write_off_amount=flt(this.frm.doc.grand_total-this.frm.doc.paid_amount+this.frm.doc.change_amount,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount"))):this.frm.doc.paid_amount=0,this.calculate_outstanding_amount(!1)}}),erpnext.TransactionController=erpnext.taxes_and_totals.extend({setup:function(){frappe.flags.hide_serial_batch_dialog=!0,this._super(),frappe.ui.form.on(this.frm.doctype+" Item","rate",function(e,t,a){var r=frappe.get_doc(t,a),i=frappe.meta.has_field(t,"margin_type");frappe.model.round_floats_in(r,["rate","price_list_rate"]),r.price_list_rate?r.rate>r.price_list_rate&&i?(r.discount_percentage=0,r.margin_type="Amount",r.margin_rate_or_amount=flt(r.rate-r.price_list_rate,precision("margin_rate_or_amount",r)),r.rate_with_margin=r.rate):(r.discount_percentage=flt(100*(1-r.rate/r.price_list_rate),precision("discount_percentage",r)),r.discount_amount=flt(r.price_list_rate)-flt(r.rate),r.margin_type="",r.margin_rate_or_amount=0,r.rate_with_margin=0):(r.discount_percentage=0,r.margin_type="",r.margin_rate_or_amount=0,r.rate_with_margin=0),r.base_rate_with_margin=r.rate_with_margin*flt(e.doc.conversion_rate),cur_frm.cscript.set_gross_profit(r),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"rate",function(e,t,a){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"tax_amount",function(e,t,a){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"row_id",function(e,t,a){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"included_in_print_rate",function(e,t,a){cur_frm.cscript.set_dynamic_labels(),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"apply_discount_on",function(e){e.doc.additional_discount_percentage?e.trigger("additional_discount_percentage"):cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"additional_discount_percentage",function(e){if(e.doc.apply_discount_on){e.via_discount_percentage=!0,e.doc.additional_discount_percentage&&e.doc.discount_amount&&(e.doc.discount_amount=0,e.cscript.calculate_taxes_and_totals());var t=flt(e.doc[frappe.model.scrub(e.doc.apply_discount_on)]),a=flt(t*flt(e.doc.additional_discount_percentage)/100,precision("discount_amount"));e.set_value("discount_amount",a).then(function(){return delete e.via_discount_percentage})}else frappe.msgprint(__("Please set 'Apply Additional Discount On'"))}),frappe.ui.form.on(this.frm.doctype,"discount_amount",function(e){e.cscript.set_dynamic_labels(),e.via_discount_percentage||(e.doc.additional_discount_percentage=0),e.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype+" Item",{items_add:function(e,t,a){var r=frappe.get_doc(t,a);!r.warehouse&&e.doc.set_warehouse&&(r.warehouse=e.doc.set_warehouse)}});var e=this;this.frm.fields_dict.items.grid.get_field("batch_no")&&this.frm.set_query("batch_no","items",function(t,a,r){return e.set_query_for_batch(t,a,r)}),this.frm.docstatus<2&&this.frm.fields_dict.payment_terms_template&&this.frm.fields_dict.payment_schedule&&this.frm.doc.payment_terms_template&&!this.frm.doc.payment_schedule.length&&this.frm.trigger("payment_terms_template"),this.frm.fields_dict.taxes&&(this.taxes_remove=this.calculate_taxes_and_totals),this.frm.fields_dict.items&&(this.items_remove=this.calculate_net_weight),this.frm.fields_dict.recurring_print_format&&this.frm.set_query("recurring_print_format",function(e){return{filters:[["Print Format","doc_type","=",cur_frm.doctype]]}}),this.frm.fields_dict.return_against&&this.frm.set_query("return_against",function(t){var a={docstatus:1,is_return:0,company:t.company};return e.frm.fields_dict.customer&&t.customer&&(a.customer=t.customer),e.frm.fields_dict.supplier&&t.supplier&&(a.supplier=t.supplier),{filters:a}}),this.frm.fields_dict.items.grid.get_field("cost_center")&&this.frm.set_query("cost_center","items",function(e){return{filters:{company:e.company,is_group:0}}}),this.frm.fields_dict.items.grid.get_field("expense_account")&&this.frm.set_query("expense_account","items",function(e){return{filters:{company:e.company}}}),frappe.meta.get_docfield(this.frm.doc.doctype,"pricing_rules")&&this.frm.set_indicator_formatter("pricing_rule",function(e){return e.rule_applied?"green":"red"});var t=this.frm.get_docfield("items","batch_no");t&&(t.get_route_options_for_new_doc=function(e){return{item:e.doc.item_code}}),this.frm.fields_dict.items.grid.get_field("blanket_order")&&this.frm.set_query("blanket_order","items",function(e,t,a){var r=locals[t][a];return{query:"erpnext.controllers.queries.get_blanket_orders",filters:{company:e.company,blanket_order_type:"Sales Order"===e.doctype?"Selling":"Purchasing",item:r.item_code}}})},onload:function(){var e=this,t=this;if(this.frm.doc.__islocal){var a=frappe.defaults.get_user_default("currency"),r=function(e,a){if(t.frm.fields_dict[e]&&!t.frm.doc[e])return t.frm.set_value(e,a)};return frappe.run_serially([function(){return r("currency",a)},function(){return r("price_list_currency",a)},function(){return r("status","Draft")},function(){return r("is_subcontracted","No")},function(){e.frm.doc.company&&!e.frm.doc.amended_from&&e.frm.trigger("company")}])}},is_return:function(){!this.frm.doc.is_return&&this.frm.doc.return_against&&this.frm.set_value("return_against","")},setup_quality_inspection:function(){if(in_list(["Delivery Note","Sales Invoice","Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype)){var e=this,t=in_list(["Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype)?"Incoming":"Outgoing";this.frm.get_docfield("items","quality_inspection").get_route_options_for_new_doc=function(a){if(!e.frm.is_new())return{inspection_type:t,reference_type:e.frm.doc.doctype,reference_name:e.frm.doc.name,item_code:a.doc.item_code,description:a.doc.description,item_serial_no:a.doc.serial_no?a.doc.serial_no.split("\n")[0]:null,batch_no:a.doc.batch_no}},this.frm.set_query("quality_inspection","items",function(e,a,r){var i=locals[a][r];return{filters:{docstatus:1,inspection_type:t,reference_name:e.name,item_code:i.item_code}}})}},make_payment_request:function(){var e=this,t=in_list(["Sales Order","Sales Invoice"],this.frm.doc.doctype)?"Inward":"Outward";frappe.call({method:"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request",args:{dt:e.frm.doc.doctype,dn:e.frm.doc.name,recipient_id:e.frm.doc.contact_email,payment_request_type:t,party_type:"Outward"==t?"Supplier":"Customer",party:"Outward"==t?e.frm.doc.supplier:e.frm.doc.customer},callback:function(e){if(!e.exc){frappe.model.sync(e.message);frappe.set_route("Form",e.message.doctype,e.message.name)}}})},onload_post_render:function(){var e=this;!this.frm.doc.__islocal||(this.frm.doc.taxes||[]).length||this.frm.doc.__onload&&this.frm.doc.__onload.load_after_mapping?this.frm.doc.__islocal&&this.frm.doc.company&&this.frm.doc.items&&!this.frm.doc.is_pos&&frappe.after_ajax(function(){return e.calculate_taxes_and_totals()}):frappe.after_ajax(function(){return e.apply_default_taxes()}),frappe.meta.get_docfield(this.frm.doc.doctype+" Item","item_code")&&(this.setup_item_selector(),this.frm.get_field("items").grid.set_multiple_add("item_code","qty"))},refresh:function(){erpnext.toggle_naming_series(),erpnext.hide_company(),this.set_dynamic_labels(),this.setup_sms(),this.setup_quality_inspection();var e=this.frm.get_field("scan_barcode");if(e&&(e.set_value(""),e.set_new_description(""),frappe.is_mobile())){if(e.$input_wrapper.find(".input-group").length)return;var t=$('<div class="input-group">');e.$input_wrapper.find(".control-input").append(t),t.append(e.$input),$('<span class="input-group-btn" style="vertical-align: top">\n\t\t\t\t\t\t<button class="btn btn-default border" type="button">\n\t\t\t\t\t\t\t<i class="fa fa-camera text-muted"></i>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</span>').on("click",".btn",function(){frappe.barcode.scan_barcode().then(function(t){e.set_value(t)})}).appendTo(t)}},scan_barcode:function(){var e=this,t=this.frm.fields_dict.scan_barcode;return this.frm.doc.scan_barcode&&frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.search_serial_or_batch_or_barcode_number",args:{search_value:this.frm.doc.scan_barcode}}).then(function(a){var r=a&&a.message;if(r&&0!==Object.keys(r).length){var i,n,s=e.frm.fields_dict.items.grid,o=null,c=e.frm.doc.items.find(function(e){return e.item_code===r.item_code}),l=e.frm.doc.items.find(function(e){return!e.item_code});c?o=c:l&&(o=l),o||(o=frappe.model.add_child(e.frm.doc,s.doctype,"items")),i=o.idx,void 0===(n=o.item_code)&&(n=null),n?t.set_new_description(__("Row #{0}: Qty increased by 1",[i])):t.set_new_description(__("Row #{0}: Item added",[i])),e.frm.from_barcode=!0,frappe.model.set_value(o.doctype,o.name,{item_code:r.item_code,qty:(o.qty||0)+1}),["serial_no","batch_no","barcode"].forEach(function(e){if(r[e]&&frappe.meta.has_field(o.doctype,e)){var t=o[e]&&"serial_no"===e?o[e]+"\n"+r[e]:r[e];frappe.model.set_value(o.doctype,o.name,e,t)}}),t.set_value(""),refresh_field("items")}else t.set_new_description(__("Cannot find Item with this barcode"))}),!1},apply_default_taxes:function(){var e=this,t=frappe.meta.get_docfield(e.frm.doc.doctype,"taxes_and_charges",e.frm.doc.name);if(this.frm.doc.taxes_and_charges||!this.frm.doc.taxes)return t?frappe.call({method:"erpnext.controllers.accounts_controller.get_default_taxes_and_charges",args:{master_doctype:t.options,tax_template:e.frm.doc.taxes_and_charges,company:e.frm.doc.company},callback:function(t){!t.exc&&t.message&&frappe.run_serially([function(){t.message.taxes_and_charges&&(e.frm.doc.taxes_and_charges=t.message.taxes_and_charges),t.message.taxes&&e.frm.set_value("taxes",t.message.taxes)},function(){return e.set_dynamic_labels()},function(){return e.calculate_taxes_and_totals()}])}}):void 0},setup_sms:function(){var e=this;1!==this.frm.doc.docstatus||in_list(["Lost","Stopped","Closed"],this.frm.doc.status)||["Purchase Invoice","BOM"].includes(this.frm.doctype)||this.frm.page.add_menu_item(__("Send SMS"),function(){e.send_sms()})},send_sms:function(){new erpnext.SMSManager(this.frm.doc)},barcode:function(e,t,a){var r=locals[t][a];""!=r.barcode&&null!=r.barcode||(r.item_code=""),this.frm.from_barcode=!0,this.item_code(e,t,a)},item_code:function(e,t,a){var r=this,i=frappe.get_doc(t,a),n=0,s=0;if(["Sales Invoice"].includes(this.frm.doc.doctype)?(n=cint(r.frm.doc.update_stock),s=n):("Purchase Receipt"===this.frm.doc.doctype&&r.frm.doc.is_return||"Delivery Note"===this.frm.doc.doctype)&&(s=1),this.frm.from_barcode||(i.barcode=null),this.frm.from_barcode=!1,i.item_code||i.barcode||i.serial_no){if(this.validate_company_and_party())return this.frm.call({method:"erpnext.stock.get_item_details.get_item_details",child:i,args:{doc:r.frm.doc,args:{item_code:i.item_code,barcode:i.barcode,serial_no:i.serial_no,batch_no:i.batch_no,set_warehouse:r.frm.doc.set_warehouse,warehouse:i.warehouse,customer:r.frm.doc.customer||r.frm.doc.party_name,quotation_to:r.frm.doc.quotation_to,supplier:r.frm.doc.supplier,currency:r.frm.doc.currency,update_stock:n,conversion_rate:r.frm.doc.conversion_rate,price_list:r.frm.doc.selling_price_list||r.frm.doc.buying_price_list,price_list_currency:r.frm.doc.price_list_currency,plc_conversion_rate:r.frm.doc.plc_conversion_rate,company:r.frm.doc.company,order_type:r.frm.doc.order_type,is_pos:cint(r.frm.doc.is_pos),is_return:cint(r.frm.doc.is_return),is_subcontracted:r.frm.doc.is_subcontracted,transaction_date:r.frm.doc.transaction_date||r.frm.doc.posting_date,ignore_pricing_rule:r.frm.doc.ignore_pricing_rule,doctype:r.frm.doc.doctype,name:r.frm.doc.name,project:i.project||r.frm.doc.project,qty:i.qty||1,stock_qty:i.stock_qty,conversion_factor:i.conversion_factor,weight_per_unit:i.weight_per_unit,weight_uom:i.weight_uom,manufacturer:i.manufacturer,stock_uom:i.stock_uom,pos_profile:"Sales Invoice"==r.frm.doc.doctype?r.frm.doc.pos_profile:"",cost_center:i.cost_center,tax_category:r.frm.doc.tax_category,item_tax_template:i.item_tax_template,child_docname:i.name}},callback:function(n){n.exc||frappe.run_serially([function(){var e=locals[t][a];r.add_taxes_from_item_tax_template(e.item_tax_rate),e.free_item_data&&r.apply_product_discount(e.free_item_data)},function(){return r.frm.script_manager.trigger("price_list_rate",t,a)},function(){return r.toggle_conversion_factor(i)},function(){!s||i.has_serial_no||i.has_batch_no||(s=!1)},function(){if(s)return frappe.db.get_value("Item",i.item_code,["has_batch_no","has_serial_no"]).then(function(e){e.message&&!frappe.flags.hide_serial_batch_dialog&&(e.message.has_batch_no||e.message.has_serial_no)&&(frappe.flags.hide_serial_batch_dialog=!1)})},function(){if(s&&!frappe.flags.hide_serial_batch_dialog){var e=locals[t][a];$.each(n.message,function(t,a){e[t]||(e[t]=a)}),e.has_batch_no&&e.has_serial_no&&(e.batch_no=void 0),erpnext.show_serial_batch_selector(r.frm,e,function(e){r.frm.script_manager.trigger("qty",e.doctype,e.name),r.frm.doc.set_warehouse||r.frm.script_manager.trigger("warehouse",e.doctype,e.name)},void 0,!frappe.flags.hide_serial_batch_dialog)}},function(){return r.conversion_factor(e,t,a,!0)},function(){return r.remove_pricing_rule(i)},function(){if(i.apply_rule_on_other_items){i.name;r.apply_rule_on_other_items({key:i})}}])}});this.frm.fields_dict.items.grid.grid_rows[i.idx-1].remove()}},add_taxes_from_item_tax_template:function(e){var t=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&("string"==typeof e&&(e=JSON.parse(e)),$.each(e,function(e,a){if(!(t.frm.doc.taxes||[]).find(function(t){return t.account_head===e})){var r=frappe.model.add_child(t.frm.doc,"taxes");r.charge_type="On Net Total",r.account_head=e,r.rate=0}}))},serial_no:function(e,t,a){var r=frappe.get_doc(t,a);if(r&&r.serial_no)if(r.item_code){var i=[],n=r.serial_no.trim().replace(/,/g,"\n");n=n.trim().split("\n");for(var s=0;s<=n.length-1;s++)""!=n[s].trim()&&-1==i.indexOf(n[s].trim())&&i.push(n[s].trim());r.serial_no=i.join("\n"),r.conversion_factor=r.conversion_factor||1,refresh_field("serial_no",r.name,r.parentfield),!e.is_return&&cint(user_defaults.set_qty_in_transactions_based_on_serial_no_input)&&(frappe.model.set_value(r.doctype,r.name,"qty",i.length/r.conversion_factor),frappe.model.set_value(r.doctype,r.name,"stock_qty",i.length))}else this.frm.trigger("item_code",t,a)},validate:function(){this.calculate_taxes_and_totals(!1)},company:function(){var e=this,t=function(){if(e.frm.doc.company&&e.frm.fields_dict.currency){var t=e.get_company_currency(),a=frappe.get_doc(":Company",e.frm.doc.company);e.frm.doc.currency||e.frm.set_value("currency",t),e.frm.doc.currency==t&&e.frm.set_value("conversion_rate",1),e.frm.doc.price_list_currency==t&&e.frm.set_value("plc_conversion_rate",1),a.default_letter_head&&e.frm.fields_dict.letter_head&&e.frm.set_value("letter_head",a.default_letter_head);a.default_selling_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&-1!=["Sales Invoice","Quotation","Sales Order","Delivery Note"].indexOf(e.frm.doc.doctype)&&e.frm.set_value("tc_name",a.default_selling_terms);a.default_buying_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&-1!=["Request for Quotation","Supplier Quotation","Purchase Order","Material Request","Purchase Receipt"].indexOf(e.frm.doc.doctype)&&e.frm.set_value("tc_name",a.default_buying_terms),frappe.run_serially([function(){return e.frm.script_manager.trigger("currency")},function(){return e.update_item_tax_map()},function(){return e.apply_default_taxes()},function(){return e.apply_pricing_rule()}])}},a=function(t){if(in_list(["Sales Invoice","Purchase Invoice"],e.frm.doc.doctype)){if("Sales Invoice"==e.frm.doc.doctype)var a="Customer",r="debit_to";else a="Supplier",r="credit_to";var i=e.frm.doc[frappe.model.scrub(a)];if(i&&e.frm.doc.company)return frappe.call({method:"erpnext.accounts.party.get_party_account",args:{company:e.frm.doc.company,party_type:a,party:i},callback:function(a){!a.exc&&a.message&&(e.frm.set_value(r,a.message),t())}});t()}else t()};if(this.frm.doc.posting_date)this.frm.doc.posting_date;else this.frm.doc.transaction_date;frappe.meta.get_docfield(this.frm.doctype,"shipping_address")&&in_list(["Purchase Order","Purchase Receipt","Purchase Invoice"],this.frm.doctype)?erpnext.utils.get_shipping_address(this.frm,function(){a(t)}):a(t),this.frm.doc.company&&(erpnext.last_selected_company=this.frm.doc.company)},transaction_date:function(){this.frm.doc.transaction_date&&(this.frm.transaction_date=this.frm.doc.transaction_date,frappe.ui.form.trigger(this.frm.doc.doctype,"currency"))},posting_date:function(){var e=this;if(this.frm.doc.posting_date){if(this.frm.posting_date=this.frm.doc.posting_date,"Sales Invoice"==this.frm.doc.doctype&&this.frm.doc.customer||"Purchase Invoice"==this.frm.doc.doctype&&this.frm.doc.supplier)return frappe.call({method:"erpnext.accounts.party.get_due_date",args:{posting_date:e.frm.doc.posting_date,party_type:"Sales Invoice"==e.frm.doc.doctype?"Customer":"Supplier",bill_date:e.frm.doc.bill_date,party:"Sales Invoice"==e.frm.doc.doctype?e.frm.doc.customer:e.frm.doc.supplier,company:e.frm.doc.company},callback:function(t,a){t.message&&(e.frm.doc.due_date=t.message,refresh_field("due_date"),frappe.ui.form.trigger(e.frm.doc.doctype,"currency"),e.recalculate_terms())}});frappe.ui.form.trigger(e.frm.doc.doctype,"currency")}},due_date:function(){if(this.frm.doc.due_date&&!this.frm.updating_party_details&&!this.frm.doc.is_pos&&(this.frm.doc.payment_terms_template||this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length)){var e="",t="",a="Please clear the ";this.frm.doc.payment_terms_template&&(a+=e="selected Payment Terms Template"),(this.frm.doc.payment_schedule||[]).length&&(t="Payment Schedule Table",0!==e.length&&(t=" and "+t),a+=t),frappe.msgprint(a)}},bill_date:function(){this.posting_date()},recalculate_terms:function(){var e=this.frm.doc;if(e.payment_terms_template)this.payment_terms_template();else if(e.payment_schedule){var t=this;e.payment_schedule.forEach(function(a){a.payment_term?t.payment_term(e,a.doctype,a.name):frappe.model.set_value(a.doctype,a.name,"due_date",e.posting_date||e.transaction_date)})}},get_company_currency:function(){return erpnext.get_currency(this.frm.doc.company)},contact_person:function(){erpnext.utils.get_contact_details(this.frm)},currency:function(){var e=this.frm.doc.transaction_date||this.frm.doc.posting_date,t=this;this.set_dynamic_labels();var a=this.get_company_currency();this.frm.doc.currency&&this.frm.doc.currency!==a&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(e,this.frm.doc.currency,a,function(e){e!=t.frm.doc.conversion_rate&&(t.set_margin_amount_based_on_currency(e),t.set_actual_charges_based_on_currency(e),t.frm.set_value("conversion_rate",e))}):this.conversion_rate()},conversion_rate:function(){this.frm;this.frm.doc.currency===this.get_company_currency()&&this.frm.set_value("conversion_rate",1),this.frm.doc.currency===this.frm.doc.price_list_currency&&this.frm.doc.plc_conversion_rate!==this.frm.doc.conversion_rate&&this.frm.set_value("plc_conversion_rate",this.frm.doc.conversion_rate),flt(this.frm.doc.conversion_rate)>0&&(this.frm.doc.ignore_pricing_rule?this.calculate_taxes_and_totals():this.in_apply_price_list||this.apply_price_list()),this.frm.set_df_property("conversion_rate","read_only",erpnext.stale_rate_allowed()?0:1)},shipping_rule:function(){var e=this,t=this;if(this.frm.doc.shipping_rule)return this.frm.call({doc:this.frm.doc,method:"apply_shipping_rule",callback:function(e){e.exc||t.calculate_taxes_and_totals()}}).fail(function(){return e.frm.set_value("shipping_rule","")});t.calculate_taxes_and_totals()},set_margin_amount_based_on_currency:function(e){in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice"]),this.frm.doc.doctype&&$.each(this.frm.doc.items||[],function(t,a){"Amount"==a.margin_type&&frappe.model.set_value(a.doctype,a.name,"margin_rate_or_amount",flt(a.margin_rate_or_amount)/flt(e))})},set_actual_charges_based_on_currency:function(e){$.each(this.frm.doc.taxes||[],function(t,a){"Actual"==a.charge_type&&frappe.model.set_value(a.doctype,a.name,"tax_amount",flt(a.tax_amount)/flt(e))})},get_exchange_rate:function(e,t,a,r){var i;if(["Quotation","Sales Order","Delivery Note","Sales Invoice"].includes(this.frm.doctype)?i="for_selling":["Purchase Order","Purchase Receipt","Purchase Invoice"].includes(this.frm.doctype)&&(i="for_buying"),e&&t&&a)return frappe.call({method:"erpnext.setup.utils.get_exchange_rate",args:{transaction_date:e,from_currency:t,to_currency:a,args:i},callback:function(e){r(flt(e.message))}})},price_list_currency:function(){var e=this;this.set_dynamic_labels();var t=this.get_company_currency();this.frm.doc.price_list_currency===t||this.frm.doc.ignore_pricing_rule?this.plc_conversion_rate():this.get_exchange_rate(this.frm.doc.posting_date,this.frm.doc.price_list_currency,t,function(t){e.frm.set_value("plc_conversion_rate",t)})},plc_conversion_rate:function(){this.frm.doc.price_list_currency===this.get_company_currency()?this.frm.set_value("plc_conversion_rate",1):this.frm.doc.price_list_currency===this.frm.doc.currency&&this.frm.doc.plc_conversion_rate&&1!=cint(this.frm.doc.plc_conversion_rate)&&cint(this.frm.doc.plc_conversion_rate)!=cint(this.frm.doc.conversion_rate)&&this.frm.set_value("conversion_rate",this.frm.doc.plc_conversion_rate),this.in_apply_price_list||this.apply_price_list(null,!0)},uom:function(e,t,a){var r=this,i=frappe.get_doc(t,a);if(i.item_code&&i.uom)return this.frm.call({method:"erpnext.stock.get_item_details.get_conversion_factor",child:i,args:{item_code:i.item_code,uom:i.uom},callback:function(e){e.exc||r.conversion_factor(r.frm.doc,t,a)}})},conversion_factor:function(e,t,a,r){if(frappe.meta.get_docfield(t,"stock_qty",a)){var i=frappe.get_doc(t,a);frappe.model.round_floats_in(i,["qty","conversion_factor"]),i.stock_qty=flt(i.qty*i.conversion_factor,precision("stock_qty",i)),refresh_field("stock_qty",i.name,i.parentfield),this.toggle_conversion_factor(i),"Material Request"!=e.doctype&&(i.total_weight=flt(i.stock_qty*i.weight_per_unit),refresh_field("total_weight",i.name,i.parentfield),this.calculate_net_weight()),!r&&frappe.meta.has_field(e.doctype,"price_list_currency")&&this.apply_price_list(i,!0)}},toggle_conversion_factor:function(e){this.frm.get_field("items").grid.fields_map.conversion_factor&&this.frm.fields_dict.items.grid.toggle_enable("conversion_factor",e.uom!=e.stock_uom&&!frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype,"conversion_factor").read_only)},qty:function(e,t,a){var r=frappe.get_doc(t,a);this.conversion_factor(e,t,a,!0),this.apply_pricing_rule(r,!0)},service_stop_date:function(e,t,a){var r=locals[t][a];if(r.service_stop_date){var i=Date.parse(r.service_start_date),n=Date.parse(r.service_end_date),s=Date.parse(r.service_stop_date);s<i?(frappe.model.set_value(t,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be before Service Start Date"))):s>n&&(frappe.model.set_value(t,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be after Service End Date")))}},service_start_date:function(e,t,a){var r=locals[t][a];r.service_start_date&&frappe.call({method:"erpnext.stock.get_item_details.calculate_service_end_date",args:{args:r},callback:function(e){frappe.model.set_value(t,a,"service_end_date",e.message.service_end_date)}})},calculate_net_weight:function(){var e=this;this.frm.doc.total_net_weight=0,$.each(this.frm.doc.items||[],function(t,a){e.frm.doc.total_net_weight+=flt(a.total_weight)}),refresh_field("total_net_weight"),this.shipping_rule()},set_dynamic_labels:function(){this.frm.toggle_reqd("plc_conversion_rate",!(!this.frm.doc.price_list_name||!this.frm.doc.price_list_currency));var e=this.get_company_currency();this.change_form_labels(e),this.change_grid_labels(e),this.frm.refresh_fields()},change_form_labels:function(e){this.frm.set_currency_labels(["base_total","base_net_total","base_total_taxes_and_charges","base_discount_amount","base_grand_total","base_rounded_total","base_in_words","base_taxes_and_charges_added","base_taxes_and_charges_deducted","total_amount_to_pay","base_paid_amount","base_write_off_amount","base_change_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],e),this.frm.set_currency_labels(["total","net_total","total_taxes_and_charges","discount_amount","grand_total","taxes_and_charges_added","taxes_and_charges_deducted","rounded_total","in_words","paid_amount","write_off_amount","operating_cost","scrap_material_cost","rounding_adjustment","raw_material_cost","total_cost"],this.frm.doc.currency),this.frm.set_currency_labels(["outstanding_amount","total_advance"],this.frm.doc.party_account_currency),cur_frm.set_df_property("conversion_rate","description","1 "+this.frm.doc.currency+" = [?] "+e),this.frm.doc.price_list_currency&&this.frm.doc.price_list_currency!=e&&cur_frm.set_df_property("plc_conversion_rate","description","1 "+this.frm.doc.price_list_currency+" = [?] "+e),this.frm.toggle_display(["conversion_rate","base_total","base_net_total","base_total_taxes_and_charges","base_taxes_and_charges_added","base_taxes_and_charges_deducted","base_grand_total","base_rounded_total","base_in_words","base_discount_amount","base_paid_amount","base_write_off_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],this.frm.doc.currency!=e),this.frm.toggle_display(["plc_conversion_rate","price_list_currency"],this.frm.doc.price_list_currency!=e);var t=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(e){return 1===e.included_in_print_rate}).length;frappe.meta.get_docfield(cur_frm.doctype,"net_total")&&cur_frm.toggle_display("net_total",t),frappe.meta.get_docfield(cur_frm.doctype,"base_net_total")&&cur_frm.toggle_display("base_net_total",t&&this.frm.doc.currency!=e)},change_grid_labels:function(e){var t=this;if(this.frm.set_currency_labels(["base_rate","base_net_rate","base_price_list_rate","base_amount","base_net_amount"],e,"items"),this.frm.set_currency_labels(["rate","net_rate","price_list_rate","amount","net_amount"],this.frm.doc.currency,"items"),this.frm.fields_dict.operations){this.frm.set_currency_labels(["operating_cost","hour_rate"],this.frm.doc.currency,"operations"),this.frm.set_currency_labels(["base_operating_cost","base_hour_rate"],e,"operations");var a=this.frm.fields_dict.operations.grid;$.each(["base_operating_cost","base_hour_rate"],function(r,i){frappe.meta.get_docfield(a.doctype,i)&&a.set_column_disp(i,t.frm.doc.currency!=e)})}if(this.frm.fields_dict.scrap_items){this.frm.set_currency_labels(["rate","amount"],this.frm.doc.currency,"scrap_items"),this.frm.set_currency_labels(["base_rate","base_amount"],e,"scrap_items");a=this.frm.fields_dict.scrap_items.grid;$.each(["base_rate","base_amount"],function(r,i){frappe.meta.get_docfield(a.doctype,i)&&a.set_column_disp(i,t.frm.doc.currency!=e)})}this.frm.fields_dict.taxes&&(this.frm.set_currency_labels(["tax_amount","total","tax_amount_after_discount"],this.frm.doc.currency,"taxes"),this.frm.set_currency_labels(["base_tax_amount","base_total","base_tax_amount_after_discount"],e,"taxes")),this.frm.fields_dict.advances&&this.frm.set_currency_labels(["advance_amount","allocated_amount"],this.frm.doc.party_account_currency,"advances");a=this.frm.fields_dict.items.grid;$.each(["base_rate","base_price_list_rate","base_amount"],function(r,i){frappe.meta.get_docfield(a.doctype,i)&&a.set_column_disp(i,t.frm.doc.currency!=e)});var r=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(e){return 1===e.included_in_print_rate}).length;$.each(["net_rate","net_amount"],function(e,t){frappe.meta.get_docfield(a.doctype,t)&&a.set_column_disp(t,r)}),$.each(["base_net_rate","base_net_amount"],function(i,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,r&&t.frm.doc.currency!=e)});$(this.frm.wrapper)},recalculate:function(){this.calculate_taxes_and_totals()},recalculate_values:function(){this.calculate_taxes_and_totals()},calculate_charges:function(){this.calculate_taxes_and_totals()},ignore_pricing_rule:function(){if(this.frm.doc.ignore_pricing_rule){var e=this,t=[];return $.each(this.frm.doc.items||[],function(e,a){a.item_code&&!a.is_free_item&&t.push({doctype:a.doctype,name:a.name,item_code:a.item_code,pricing_rules:a.pricing_rules,parenttype:a.parenttype,parent:a.parent})}),this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules",args:{item_list:t},callback:function(t){!t.exc&&t.message&&(t.message.forEach(function(t){e.remove_pricing_rule(t)}),e._set_values_for_item_list(t.message),e.calculate_taxes_and_totals(),e.frm.doc.apply_discount_on&&e.frm.trigger("apply_discount_on"))}})}this.apply_pricing_rule()},apply_pricing_rule:function(e,t){var a=this,r=this._get_args(e);if(r.items&&r.items.length)return this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule",args:{args:r,doc:a.frm.doc},callback:function(t){!t.exc&&t.message&&(a._set_values_for_item_list(t.message),e&&a.set_gross_profit(e),a.frm.doc.apply_discount_on&&a.frm.trigger("apply_discount_on"))}});t&&a.calculate_taxes_and_totals()},_get_args:function(e){var t=this;return{items:this._get_item_list(e),customer:t.frm.doc.customer||t.frm.doc.party_name,quotation_to:t.frm.doc.quotation_to,customer_group:t.frm.doc.customer_group,territory:t.frm.doc.territory,supplier:t.frm.doc.supplier,supplier_group:t.frm.doc.supplier_group,currency:t.frm.doc.currency,conversion_rate:t.frm.doc.conversion_rate,price_list:t.frm.doc.selling_price_list||t.frm.doc.buying_price_list,price_list_currency:t.frm.doc.price_list_currency,plc_conversion_rate:t.frm.doc.plc_conversion_rate,company:t.frm.doc.company,transaction_date:t.frm.doc.transaction_date||t.frm.doc.posting_date,campaign:t.frm.doc.campaign,sales_partner:t.frm.doc.sales_partner,ignore_pricing_rule:t.frm.doc.ignore_pricing_rule,doctype:t.frm.doc.doctype,name:t.frm.doc.name,is_return:cint(t.frm.doc.is_return),update_stock:in_list(["Sales Invoice","Purchase Invoice"],t.frm.doc.doctype)?cint(t.frm.doc.update_stock):0,conversion_factor:t.frm.doc.conversion_factor,pos_profile:"Sales Invoice"==t.frm.doc.doctype?t.frm.doc.pos_profile:"",coupon_code:t.frm.doc.coupon_code}},_get_item_list:function(e){var t=[],a=function(e){e.item_code&&(t.push({doctype:e.doctype,name:e.name,child_docname:e.name,item_code:e.item_code,item_group:e.item_group,brand:e.brand,qty:e.qty,stock_qty:e.stock_qty,uom:e.uom,stock_uom:e.stock_uom,parenttype:e.parenttype,parent:e.parent,pricing_rules:e.pricing_rules,warehouse:e.warehouse,serial_no:e.serial_no,price_list_rate:e.price_list_rate,conversion_factor:e.conversion_factor||1}),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item"]),e.doctype&&(t[0].margin_type=e.margin_type,t[0].margin_rate_or_amount=e.margin_rate_or_amount))};return e?a(e):$.each(this.frm.doc.items||[],function(e,t){a(t)}),t},_set_values_for_item_list:function(e){for(var t=this,a=!1,r={},i=0,n=e.length;i<n;i++){var s=e[i],o=frappe.model.get_value(s.doctype,s.name,"pricing_rules");for(var c in s){var l=s[c];-1===["doctype","name"].indexOf(c)&&("price_list_rate"==c&&flt(l)!=flt(s.price_list_rate)&&(a=!0),frappe.model.set_value(s.doctype,s.name,c,l))}t.frm.doc.ignore_pricing_rule||!o||s.pricing_rules?s.pricing_rules||t.remove_pricing_rule(frappe.get_doc(s.doctype,s.name)):t.apply_price_list(frappe.get_doc(s.doctype,s.name)),s.free_item_data&&t.apply_product_discount(s.free_item_data),s.apply_rule_on_other_items&&(r[s.name]=s)}t.apply_rule_on_other_items(r),a||t.calculate_taxes_and_totals()},apply_rule_on_other_items:function(e){var t=this,a=["discount_percentage","pricing_rules","discount_amount","rate"],r=function(r){var i=e[r];i&&i.apply_rule_on_other_items&&t.frm.doc.items.forEach(function(e){if(in_list(JSON.parse(i.apply_rule_on_other_items),e[i.apply_rule_on]))for(var t in i)in_list(a,t)&&i[t]&&("Price"===i.price_or_product_discount||"pricing_rules"===t)&&frappe.model.set_value(e.doctype,e.name,t,i[t])})};for(var i in e)r(i)},apply_product_discount:function(e){var t=this.frm.doc.items.filter(function(t){return t.item_code==e.item_code&&t.is_free_item})||[];if(!t.length){var a=frappe.model.add_child(this.frm.doc,this.frm.doc.doctype+" Item","items");for(var r in e)a[r]=e[r]}t&&t.length&&e&&(t[0].qty=e.qty)},apply_price_list:function(e,t){t||this.frm.set_value("plc_conversion_rate","");var a=this,r=this._get_args(e);if((r.items&&r.items.length||r.price_list)&&1!=a.in_apply_price_list)return a.in_apply_price_list=!0,this.frm.call({method:"erpnext.stock.get_item_details.apply_price_list",args:{args:r},callback:function(e){e.exc?a.in_apply_price_list=!1:frappe.run_serially([function(){return a.frm.set_value("price_list_currency",e.message.parent.price_list_currency)},function(){return a.frm.set_value("plc_conversion_rate",e.message.parent.plc_conversion_rate)},function(){r.items.length&&a._set_values_for_item_list(e.message.children)},function(){a.in_apply_price_list=!1}])}}).always(function(){a.in_apply_price_list=!1})},remove_pricing_rule:function(e){var t=["discount_percentage","discount_amount","margin_rate_or_amount","rate_with_margin"];if(e.remove_free_item){var a=[];this.frm.doc.items.forEach(function(t){t.item_code==e.remove_free_item&&t.is_free_item||a.push(t)}),this.frm.doc.items=a,refresh_field("items")}else if(e.applied_on_items&&e.apply_on){var r=JSON.parse(e.applied_on_items);this.frm.doc.items.forEach(function(a){in_list(r,a[e.apply_on])&&(t.forEach(function(e){a[e]=0}),["pricing_rules","margin_type"].forEach(function(e){a[e]&&(a[e]="")}))}),this.trigger_price_list_rate()}},trigger_price_list_rate:function(){var e=this;this.frm.doc.items.forEach(function(t){e.frm.script_manager.trigger("price_list_rate",t.doctype,t.name)})},validate_company_and_party:function(){var e=this,t=!0;return $.each(["company","customer"],function(a,r){frappe.meta.has_field(e.frm.doc.doctype,r)&&"Purchase Order"!=e.frm.doc.doctype&&(e.frm.doc[r]||(frappe.msgprint(__("Please specify")+": "+frappe.meta.get_label(e.frm.doc.doctype,r,e.frm.doc.name)+". "+__("It is needed to fetch Item Details.")),t=!1))}),t},get_terms:function(){var e=this;erpnext.utils.get_terms(this.frm.doc.tc_name,this.frm.doc,function(t){t.exc||e.frm.set_value("terms",t.message)})},taxes_and_charges:function(){var e=this;if(this.frm.doc.taxes_and_charges)return this.frm.call({method:"erpnext.controllers.accounts_controller.get_taxes_and_charges",args:{master_doctype:frappe.meta.get_docfield(this.frm.doc.doctype,"taxes_and_charges",this.frm.doc.name).options,master_name:this.frm.doc.taxes_and_charges},callback:function(t){if(!t.exc)if(e.frm.doc.shipping_rule&&e.frm.doc.taxes){for(var a=0,r=t.message;a<r.length;a+=1){var i=r[a];e.frm.add_child("taxes",i)}refresh_field("taxes")}else e.frm.set_value("taxes",t.message),e.calculate_taxes_and_totals()}})},tax_category:function(){var e=this;this.frm.updating_party_details||frappe.run_serially([function(){return e.update_item_tax_map()},function(){return erpnext.utils.set_taxes(e.frm,"tax_category")}])},item_tax_template:function(e,t,a){var r=this;if(!r.frm.updating_party_details){var i=frappe.get_doc(t,a);if(i.item_tax_template)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_map",args:{company:r.frm.doc.company,item_tax_template:i.item_tax_template,as_json:!0},callback:function(e){e.exc||(i.item_tax_rate=e.message,r.add_taxes_from_item_tax_template(i.item_tax_rate),r.calculate_taxes_and_totals())}});i.item_tax_rate="{}",r.calculate_taxes_and_totals()}},update_item_tax_map:function(){var e=this,t=[];if($.each(this.frm.doc.items||[],function(e,a){a.item_code&&t.push(a.item_code)}),t.length)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_info",args:{company:e.frm.doc.company,tax_category:cstr(e.frm.doc.tax_category),item_codes:t},callback:function(t){t.exc||($.each(e.frm.doc.items||[],function(a,r){r.item_code&&t.message.hasOwnProperty(r.item_code)?(r.item_tax_template||(r.item_tax_template=t.message[r.item_code].item_tax_template,r.item_tax_rate=t.message[r.item_code].item_tax_rate),e.add_taxes_from_item_tax_template(r.item_tax_rate)):(r.item_tax_template="",r.item_tax_rate="{}")}),e.calculate_taxes_and_totals())}})},is_recurring:function(){if(this.frm.doc.is_recurring&&this.frm.doc.__islocal)return frappe.msgprint(__("Please set recurring after saving")),void this.frm.set_value("is_recurring",0);if(this.frm.doc.is_recurring){this.frm.doc.recurring_id||this.frm.set_value("recurring_id",this.frm.doc.name);var e="Administrator"==this.frm.doc.owner?frappe.user_info("Administrator").email:this.frm.doc.owner;this.frm.doc.notification_email_address=$.map([cstr(e),cstr(this.frm.doc.contact_email)],function(e){return e||null}).join(", "),this.frm.doc.repeat_on_day_of_month=frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate()}refresh_many(["notification_email_address","repeat_on_day_of_month"])},from_date:function(){if(this.frm.doc.from_date){var e={Monthly:1,Quarterly:3,"Half-yearly":6,Yearly:12}[this.frm.doc.recurring_type];if(e){var t=frappe.datetime.add_months(this.frm.doc.from_date,e);this.frm.doc.to_date=frappe.datetime.add_days(t,-1),refresh_field("to_date")}}},set_gross_profit:function(e){if("Sales Order"==this.frm.doc.doctype&&e.valuation_rate){var t=flt(e.rate)*flt(this.frm.doc.conversion_rate||1);e.gross_profit=flt((t-e.valuation_rate)*e.stock_qty,precision("amount",e))}},setup_item_selector:function(){},get_advances:function(){if(!this.frm.is_return)return this.frm.call({method:"set_advances",doc:this.frm.doc,callback:function(e,t){refresh_field("advances")}})},make_payment_entry:function(){return frappe.call({method:cur_frm.cscript.get_method_for_payment(),args:{dt:cur_frm.doc.doctype,dn:cur_frm.doc.name},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})},get_method_for_payment:function(){var e="erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry";return cur_frm.doc.__onload&&cur_frm.doc.__onload.make_payment_via_journal_entry&&(e=in_list(["Sales Invoice","Purchase Invoice"],cur_frm.doc.doctype)?"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice":"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order"),e},set_query_for_batch:function(e,t,a){var r=frappe.get_doc(t,a);if(r.item_code){if("Purchase Receipt"==e.doctype||"Purchase Invoice"==e.doctype&&e.update_stock)return{filters:{item:r.item_code}};var i={item_code:r.item_code,posting_date:this.frm.doc.posting_date||frappe.datetime.nowdate()};return e.is_return&&(i.is_return=1),r.warehouse&&(i.warehouse=r.warehouse),{query:"erpnext.controllers.queries.get_batch_no",filters:i}}frappe.throw(__("Please enter Item Code to get batch no"))},set_query_for_item_tax_template:function(e,t,a){var r=frappe.get_doc(t,a);if(r.item_code){var i={item_code:r.item_code,valid_from:["<=",e.transaction_date||e.bill_date||e.posting_date],item_group:r.item_group};return e.tax_category&&(i.tax_category=e.tax_category),{query:"erpnext.controllers.queries.get_tax_template",filters:i}}frappe.throw(__("Please enter Item Code to get item taxes"))},payment_terms_template:function(){var e=this,t=this.frm.doc;if(t.payment_terms_template&&"Delivery Note"!==t.doctype){var a=t.posting_date||t.transaction_date;frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_terms",args:{terms_template:t.payment_terms_template,posting_date:a,grand_total:t.rounded_total||t.grand_total,bill_date:t.bill_date},callback:function(t){t.message&&!t.exc&&e.frm.set_value("payment_schedule",t.message)}})}},payment_term:function(e,t,a){var r=locals[t][a];r.payment_term&&frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_term_details",args:{term:r.payment_term,bill_date:this.frm.doc.bill_date,posting_date:this.frm.doc.posting_date||this.frm.doc.transaction_date,grand_total:this.frm.doc.rounded_total||this.frm.doc.grand_total},callback:function(e){if(e.message&&!e.exc)for(var r in e.message)frappe.model.set_value(t,a,r,e.message[r])}})},blanket_order:function(e,t,a){var r=this,i=locals[t][a];!i.blanket_order||"Sales Order"!=i.parenttype&&"Purchase Order"!=i.parenttype||frappe.call({method:"erpnext.stock.get_item_details.get_blanket_order_details",args:{args:{item_code:i.item_code,customer:e.customer,supplier:e.supplier,company:e.company,transaction_date:e.transaction_date,blanket_order:i.blanket_order}},callback:function(e){e.message?frappe.run_serially([function(){return frappe.model.set_value(t,a,"blanket_order_rate",e.message.blanket_order_rate)},function(){return r.frm.script_manager.trigger("price_list_rate",t,a)}]):frappe.throw(__("Invalid Blanket Order for the selected Customer and Item"))}})},set_reserve_warehouse:function(){this.autofill_warehouse(this.frm.doc.supplied_items,"reserve_warehouse",this.frm.doc.set_reserve_warehouse)},set_warehouse:function(){this.autofill_warehouse(this.frm.doc.items,"warehouse",this.frm.doc.set_warehouse)},autofill_warehouse:function(e,t,a){if(a&&e&&e.length){var r=e[0].doctype;$.each(e||[],function(e,i){frappe.model.set_value(r,i.name,t,a)})}},coupon_code:function(){var e=this,t=this;frappe.run_serially([function(){return e.frm.doc.ignore_pricing_rule=1},function(){return t.ignore_pricing_rule()},function(){return e.frm.doc.ignore_pricing_rule=0},function(){return t.apply_pricing_rule()}])}}),erpnext.show_serial_batch_selector=function(e,t,a,r,i){frappe.require("assets/erpnext/js/utils/serial_no_batch_selector.js",function(){new erpnext.SerialNoBatchSelector({frm:e,item:t,warehouse_details:{type:"Warehouse",name:t.warehouse},callback:a,on_close:r},i)})},frappe.templates.pos='<div class="pos">  <div class="row">   <div class="col-sm-5 pos-bill-wrapper">    <div class="col-sm-12"><h6 class="form-section-heading uppercase">{{ __("Item Cart") }}</h6></div>    <div class="pos-bill">     <div class="item-cart">      <div class="pos-list-row pos-bill-header text-muted h6">       <span class="cell subject">                {{ __("Item Name")}}       </span>       <span class="cell text-right">{{ __("Quantity") }}</span>       <span class="cell text-right">{{ __("Discount") }}</span>       <span class="cell text-right">{{ __("Rate") }}</span>      </div>      <div class="item-cart-items">       <div class="no-items-message text-extra-muted">        <span class="text-center">         <i class="fa fa-2x fa-shopping-cart"></i>         <p>{{ __("Tap items to add them here") }}</p>        </span>       </div>       <div class="items">       </div>      </div>     </div>    </div>    <div class="totals-area">     <div class="pos-list-row net-total-area">      <div class="cell"></div>      <div class="cell text-right">{%= __("Net Total") %}</div>      <div class="cell price-cell bold net-total text-right"></div>     </div>     <div class="pos-list-row tax-area">      <div class="cell"></div>      <div class="cell text-right">{%= __("Taxes") %}</div>      <div class="cell price-cell text-right tax-table">      </div>     </div>     {% if(allow_user_to_edit_discount) { %}      <div class="pos-list-row discount-amount-area">       <div class="cell"></div>       <div class="cell text-right">{%= __("Discount") %}</div>       <div class="cell price-cell discount-field-col">        <div class="input-group input-group-sm">         <span class="input-group-addon">%</span>         <input type="text" class="form-control discount-percentage text-right">        </div>        <div class="input-group input-group-sm">         <span class="input-group-addon">{%= get_currency_symbol(currency) %}</span>         <input type="text" class="form-control discount-amount text-right" placeholder="{%= 0.00 %}">        </div>       </div>      </div>     {% } %}     <div class="pos-list-row grand-total-area collapse-btn" style="border-bottom:1px solid #d1d8dd;">      <div class="cell">       <a class="">        <i class="octicon octicon-chevron-down"></i>       </a>      </div>      <div class="cell text-right bold">{%= __("Grand Total") %}</div>      <div class="cell price-cell grand-total text-right lead"></div>     </div>     <div class="pos-list-row qty-total-area collapse-btn" style="border-bottom:1px solid #d1d8dd;">      <div class="cell">       <a class="">        <i class="octicon octicon-chevron-down"></i>       </a>      </div>      <div class="cell text-right bold">{%= __("Qty Total") %}</div>      <div class="cell price-cell qty-total text-right lead"></div>     </div>    </div>    <div class="row" style="margin-top: 30px">     <div class="col-sm-6 selected-item">      </div>     <div class="col-xs-6 numeric_keypad hidden-xs" style="display:none">      {% var chartData = ["Qty", "Disc", "Price"] %} {% for(var i=0; i      <3; i++) { %} <div class="row text-right">       {% for(var j=i*3; j       <(i+1)*3; j++) { %} <button type="button" class="btn btn-default numeric-keypad" val="{{j+1}}">{{j+1}}</button>        {% } %}        <button type="button" {% if((!allow_user_to_edit_rate && __(chartData[i]) == __("Price")) || (!allow_user_to_edit_discount && __(chartData[i]) == __("Disc"))) { %} disabled {% } %} id="pos-item-{{ chartData[i].toLowerCase() }}" class="btn text-center btn-default numeric-keypad pos-operation">{{ __(chartData[i]) }}</button>     </div>     {% } %}     <div class="row text-right">      <button type="button" class="btn btn-default numeric-keypad numeric-del">{{ __("Del") }}</button>      <button type="button" class="btn btn-default numeric-keypad" val="0">0</button>      <button type="button" class="btn btn-default numeric-keypad" val=".">.</button>      <button type="button" class="btn btn-primary numeric-keypad pos-pay">{{ __("Pay") }}</button>     </div>    </div>   </div>  </div>  <div class="col-sm-5 list-customers">   <div class="col-sm-12"><h6 class="form-section-heading uppercase">{{ __("Customers in Queue") }}</h6></div>   <div class="pos-list-row pos-bill-header">    <div class="cell subject"><input class="list-select-all" type="checkbox">{{ __("Customer") }}</div>    <div class="cell text-left">{{ __("Status") }}</div>    <div class="cell text-right">{{ __("Amount") }}</div>    <div class="cell text-right">{{ __("Grand Total") }}</div>   </div>   <div class="list-customers-table border-left border-right border-bottom">    <div class="no-items-message text-extra-muted">     <span class="text-center">      <i class="fa fa-2x fa-user"></i>      <p>{{ __("No Customers yet!") }}</p>     </span>    </div>   </div>  </div>  <div class="col-sm-7 pos-items-section">   <div class="col-sm-12"><h6 class="form-section-heading uppercase">{{ __("Stock Items") }}</h6></div>   <div class="row pos-item-area">    </div>   <span id="customer-results" style="color:#68a;"></span>   <div class="item-list-area">    <div class="pos-list-row pos-bill-header text-muted h6">     <div class="cell subject search-item-group">      <div class="dropdown">       <a class="text-muted dropdown-toggle" data-toggle="dropdown"><span class="dropdown-text">{{ __("All Item Groups") }}</span><i class="caret"></i></a>       <ul class="dropdown-menu">       </ul>      </div>     </div>     <div class="cell search-item"></div>    </div>    <div class="app-listing item-list image-view-container">     </div>   </div>  </div> </div> ',frappe.templates.pos_bill_item='<div class="row pos-bill-row pos-bill-item" data-item-code="{%= item_code %}">     <div class="col-xs-4"><h6>{%= item_code || "" %}{%= __(item_name) || "" %}</h6></div>     <div class="col-xs-3">         <div class="row pos-qty-row">             <div class="col-xs-2 text-center pos-qty-btn" data-action="decrease-qty"><i class="fa fa-minus text-muted" style="font-size:12px"></i></div>             <div class="col-xs-8">     <div>                     <input type="tel" value="{%= qty %}" class="form-control   pos-item-qty text-right">                 </div>                 {% if(actual_qty != null) { %}                 <div style="margin-top: 5px;" class="text-muted small text-right">                     {%= __("In Stock: ") %} <span>{%= actual_qty || 0.0 %}</span>                 </div>                 {% } %}             </div>             <div class="col-xs-2 text-center pos-qty-btn" data-action="increase-qty"><i class="fa fa-plus text-muted" style="font-size:12px"></i></div>         </div>     </div>     <div class="col-xs-2 text-right">   <div class="row input-sm">             <input type="tel" value="{%= discount_percentage %}" class="form-control text-right pos-item-disc">         </div>     </div>     <div class="col-xs-3 text-right">         <div class="text-muted" style="margin-top: 5px;">    {% if(enabled) { %}     <input type="tel" value="{%= rate %}" class="form-control input-sm pos-item-price text-right">    {% } else { %}     <h6>{%= format_currency(rate) %}</h6>    {% } %}   </div>   <p><h6>{%= amount %}</h6></p>     </div> </div> ',frappe.templates.pos_bill_item_new='<div class="pos-list-row pos-bill-item {{ selected_class }}" data-item-code="{{ item_code }}">  <div class="cell subject">      <a class="grey list-id" title="{{ title }}">{{ strip_html(__(title)) }}</a>  </div>  <div class="cell text-right">{%= qty %}</div>  <div class="cell text-right">{%= discount_percentage %}</div>  <div class="cell text-right">{%= format_currency(rate) %}</div> </div> ',frappe.templates.pos_selected_item='<div class="pos-selected-item-action" data-item-code="{%= item_code %}" data-idx="{%= idx %}">  <div class="pos-list-row">   <div class="cell">{{ __("Quantity") }}:</div>   <input type="tel" class="form-control cell pos-item-qty" value="{%= qty %}"/>  </div>  <div class="pos-list-row">   <div class="cell">{{ __("Price List Rate") }}:</div>   <input type="tel" class="form-control cell" disabled value="{%= price_list_rate %}"/>  </div>  <div class="pos-list-row">   <div class="cell">{{ __("Discount") }}: %</div>   <input type="tel" class="form-control cell pos-item-disc" {% if !allow_user_to_edit_discount %} disabled {% endif %} value="{%= discount_percentage %}">  </div>  <div class="pos-list-row">   <div class="cell">{{ __("Price") }}:</div>   <input type="tel" class="form-control cell pos-item-price" {% if !allow_user_to_edit_rate %} disabled {% endif %} value="{%= rate %}"/>  </div>   <div class="pos-list-row">   <div class="cell">{{ __("Amount") }}:</div>   <input type="tel" class="form-control cell pos-amount" disabled value="{%= amount %}"/>  </div> </div>',frappe.templates.pos_item='<div class="pos-item-wrapper image-view-item" data-item-code="{{item_code}}">  <div class="image-view-header doclist-row">   <div class="list-value">    <a class="grey list-id" data-name="{{item_code}}" title="{{ title }}">{{ title }}<br>({{ __(item_stock) }})</a>   </div>  </div>  <div class="image-view-body">   <a  data-item-code="{{ item_code }}"    title="{{ title }}"   >    <div class="image-field"     style="     {% if (!item_image) { %}      background-color: #fafbfc;     {% } %}     border: 0px;"    >     {% if (!item_image) { %}     <span class="placeholder-text">      {%= frappe.get_abbr(item_name || item_code) %}     </span>     {% } %}     {% if (item_image) { %}     <img src="{{ item_image }}" alt="{{item_name || item_code}}">     {% } %}    </div>    <span class="price-info">     {{item_price}} / {{item_uom}}    </span>   </a>  </div> </div>',frappe.templates.pos_tax_row='<div class="pos-list-row" style="padding-right: 0;">  <div class="cell">{%= description %}</div>  <div class="cell text-right bold">{%= tax_amount %}</div> </div> ',frappe.templates.customer_toolbar='<div class="pos-bill-toolbar col-xs-9" style="display: flex; width: 70%;">  <div class="party-area" style="flex: 1;">   <span class="edit-customer-btn text-muted" style="display: inline;">    <a class="btn-open no-decoration" title="Edit Customer">     <i class="octicon octicon-pencil"></i>    </a>    </span>  </div>  <button class="btn btn-default list-customers-btn" style="margin-left: 12px">   <i class="octicon octicon-organization"></i>  </button>  </button> {% if (allow_delete) { %}  <button class="btn btn-default btn-danger" style="margin: 0 5px 0 5px">    <i class="octicon octicon-trashcan"></i>   </button> {% } %} </div>',frappe.templates.pos_invoice_list='<div class="pos-list-row" invoice-name = "{{name}}">  <div class="list-column cell subject" invoice-name = "{{name}}">   <input class="list-delete text-left" type="checkbox" style = "margin-right:5px">   <a class="grey list-id text-left customer-row" title="{{ customer }}">{%= customer %}</a>  </div>  <div class="list-column cell text-left customer-row"><span class="indicator {{data.indicator}}">{{ data.status }}</span></div>  <div class="list-column cell text-right customer-row">{%= paid_amount %}</div>  <div class="list-column cell text-right customer-row">{%= grand_total %}</div> </div> ',frappe.templates.pos_payment='<div class="pos_payment row">  <div class="row" style="padding: 0px 30px;">   <h3>{{ __("Total Amount") }}: <span class="label label-default" style="font-size:20px;padding:5px">{%= format_currency(grand_total, currency) %}</span></h3>  </div>  <div class="row amount-row">   <div class="col-xs-6 col-sm-3 text-center">    <p class="amount-label"> {{ __("Paid") }} <h3 class="paid_amount">{%= format_currency(paid_amount, currency) %}</h3></p>   </div>   <div class="col-xs-6 col-sm-3 text-center">    <p class="amount-label"> {{ __("Outstanding") }} <h3 class="outstanding_amount">{%= format_currency(outstanding_amount, currency) %} </h3></p>   </div>   <div class="col-xs-6 col-sm-3 text-center">    <p class="amount-label"> {{ __("Change") }} <input class="form-control text-right change_amount bold" type="text" idx="change_amount" value="{{format_number(change_amount, null, 2)}}">    </p>   </div>   <div class="col-xs-6 col-sm-3 text-center">    <p class="amount-label"> {{ __("Write off") }} <input class="form-control text-right write_off_amount bold" type="text" idx="write_off_amount" value="{{format_number(write_off_amount, null, 2)}}">    </p>   </div>  </div>  <hr>  <div class="row">   <div class="col-sm-6 ">    <div class ="row multimode-payments" style = "margin-right:10px">    </div>   </div>   <div class="col-sm-6 payment-toolbar">    {% for(var i=0; i<3; i++) { %}     <div class="row">      {% for(var j=i*3; j<(i+1)*3; j++) { %}       <button type="button"  class="btn btn-default pos-keyboard-key">{{j+1}}</button>      {% } %}     </div>    {% } %}    <div class="row">     <button type="button"  class="btn btn-default delete-btn">{{ __("Del") }}</button>     <button type="button"  class="btn btn-default pos-keyboard-key">0</button>     <button type="button"  class="btn btn-default pos-keyboard-key">.</button>    </div>         </div>  </div> </div> ',frappe.templates.payment_details='<div class="row pos-payment-row" type="{{type}}" idx={{idx}}>     <div class="col-xs-6" style="padding:20px">{{mode_of_payment}}</div>  <div class="col-xs-6">   <div class="input-group">    <input disabled class="form-control text-right amount" idx="{{idx}}" type="text" value="{%= format_currency(amount, currency) %}">    <span class="input-group-btn">     <button type="button" class="btn btn-default clr" idx="{{idx}}" style="border:1px solid #d1d8dd">C</button>    </span>   </div>  </div> </div>',frappe.templates.item_selector='<div class="app-listing item-list image-view-container item-selector"> {% for (var i=0; i < data.length; i++) { var item = data[i]; %}  {% if (i % 4 === 0) { %}<div class="image-view-row">{% } %}  <div class="image-view-item" data-name="{{ item.name }}">   <div class="image-view-header doclist-row">    <div class="list-value">     <a class="grey list-id" data-name="{{item.name}}"      title="{{ item.item_name || item.name}}">      {{item.item_name || item.name}}</a>    </div>   </div>   <div class="image-view-body">    <a  data-item-code="{{ item.name }}"     title="{{ item.item_name || item.name }}"    >     <div class="image-field"      style="      {% if (!item.image) { %}       background-color: #fafbfc;      {% } %}      border: 0px;"     >      {% if (!item.image) { %}      <span class="placeholder-text">       {%= frappe.get_abbr(item.item_name || item.name) %}      </span>      {% } %}      {% if (item.image) { %}      <img src="{{ item.image }}" alt="{{item.item_name || item.name}}">      {% } %}     </div>    </a>   </div>  </div>  {% if ((i % 4 === 3) || (i===data.length - 1)) { %}</div>{% } %} {% endfor %} </div>',frappe.templates.employees_to_mark_attendance='{% if data %} <div class="col-md-12 col-xs-12" align="center">  <div class="col-md-12 col-xs-12" style="padding-bottom:15px;">   <b>Employees to mark attendance</b>  </div>  {% for item in data %}  <div class="col-md-4 col-xs-6" style="padding-bottom:10px;">   {{ item.employee }} &nbsp;&nbsp; {{ item.employee_name }}  </div>  {% } %} </div> {% } else { %} <div></div> {% } %} ',erpnext.ItemSelector=Class.extend({init:function(e){$.extend(this,e),this.item_field||(this.item_field="item_code"),this.item_query||(this.item_query=erpnext.queries.item().query),this.grid=this.frm.get_field("items").grid,this.setup()},setup:function(){var e=this;this.grid.add_items_button||(this.grid.add_items_button=this.grid.add_custom_button(__("Add Items"),function(){e.dialog||e.make_dialog(),e.dialog.show(),e.render_items(),setTimeout(function(){e.dialog.input.focus()},1e3)}))},make_dialog:function(){this.dialog=new frappe.ui.Dialog({title:__("Add Items")});var e=$(this.dialog.body);e.html('<div><p><input type="text" class="form-control"></p>\t\t\t<br><div class="results"></div></div>'),this.dialog.input=e.find(".form-control"),this.dialog.results=e.find(".results");var t=this;this.dialog.results.on("click",".image-view-item",function(){t.add_item($(this).attr("data-name"))}),this.dialog.input.on("keyup",function(){t.timeout_id&&clearTimeout(t.timeout_id),t.timeout_id=setTimeout(function(){t.render_items(),t.timeout_id=void 0},500)})},add_item:function(e){var t=this,a=!1;if($.each(this.frm.doc.items||[],function(r,i){if(i[t.item_field]===e)return frappe.model.set_value(i.doctype,i.name,"qty",i.qty+1),frappe.show_alert({message:__("Added {0} ({1})",[e,i.qty]),indicator:"green"}),a=!0,!1}),!a){var r=null;frappe.run_serially([function(){r=t.grid.add_new_row()},function(){return frappe.model.set_value(r.doctype,r.name,t.item_field,e)},function(){return frappe.timeout(.1)},function(){frappe.model.set_value(r.doctype,r.name,"qty",1),frappe.show_alert({message:__("Added {0} ({1})",[e,1]),indicator:"green"})}])}},render_items:function(){var e={query:this.item_query,filters:{}};e.txt=this.dialog.input.val(),e.as_dict=1,this.get_filters&&$.extend(e.filters,this.get_filters()||{});var t=this;frappe.link_search("Item",e,function(e){$.each(e.values,function(e,t){t.image||(t.abbr=frappe.get_abbr(t.item_name),t.color=frappe.get_palette(t.item_name))}),t.dialog.results.html(frappe.render_template("item_selector",{data:e.values}))})}}),frappe.provide("frappe.help.help_links");var e="https://erpnext.com/docs/";frappe.help.help_links["Form/Rename Tool"]=[{label:"Bulk Rename",url:e+"user/manual/en/setting-up/data/bulk-rename"}],frappe.help.help_links["List/User"]=[{label:"New User",url:e+"user/manual/en/setting-up/users-and-permissions/adding-users"},{label:"Rename User",url:e+"user/manual/en/setting-up/articles/rename-user"}],frappe.help.help_links["permission-manager"]=[{label:"Role Permissions Manager",url:e+"user/manual/en/setting-up/users-and-permissions/role-based-permissions"},{label:"Managing Perm Level in Permissions Manager",url:e+"user/manual/en/setting-up/articles/managing-perm-level"},{label:"User Permissions",url:e+"user/manual/en/setting-up/users-and-permissions/user-permissions"},{label:"Sharing",url:e+"user/manual/en/setting-up/users-and-permissions/sharing"},{label:"Password",url:e+"user/manual/en/setting-up/articles/change-password"}],frappe.help.help_links["Form/System Settings"]=[{label:"Naming Series",url:e+"user/manual/en/setting-up/settings/system-settings"}],frappe.help.help_links["data-import-tool"]=[{label:"Importing and Exporting Data",url:e+"user/manual/en/setting-up/data/data-import-tool"},{label:"Overwriting Data from Data Import Tool",url:e+"user/manual/en/setting-up/articles/overwriting-data-from-data-import-tool"}],frappe.help.help_links.module_setup=[{label:"Role Permissions Manager",url:e+"user/manual/en/setting-up/users-and-permissions/role-based-permissions"}],frappe.help.help_links["Form/Naming Series"]=[{label:"Naming Series",url:e+"user/manual/en/setting-up/settings/naming-series"},{label:"Setting the Current Value for Naming Series",url:e+"user/manual/en/setting-up/articles/naming-series-current-value"}],frappe.help.help_links["Form/Global Defaults"]=[{label:"Global Settings",url:e+"user/manual/en/setting-up/settings/global-defaults"}],frappe.help.help_links["Form/Email Digest"]=[{label:"Email Digest",url:e+"user/manual/en/setting-up/email/email-digest"}],frappe.help.help_links["List/Print Heading"]=[{label:"Print Heading",url:e+"user/manual/en/setting-up/print/print-headings"}],frappe.help.help_links["List/Letter Head"]=[{label:"Letter Head",url:e+"user/manual/en/setting-up/print/letter-head"}],frappe.help.help_links["List/Address Template"]=[{label:"Address Template",url:e+"user/manual/en/setting-up/print/address-template"}],frappe.help.help_links["List/Terms and Conditions"]=[{label:"Terms and Conditions",url:e+"user/manual/en/setting-up/print/terms-and-conditions"}],frappe.help.help_links["List/Cheque Print Template"]=[{label:"Cheque Print Template",url:e+"user/manual/en/setting-up/print/cheque-print-template"}],frappe.help.help_links["List/Email Account"]=[{label:"Email Account",url:e+"user/manual/en/setting-up/email/email-account"}],frappe.help.help_links["List/Notification"]=[{label:"Notification",url:e+"user/manual/en/setting-up/email/notifications"}],frappe.help.help_links["Form/Notification"]=[{label:"Notification",url:e+"user/manual/en/setting-up/email/notifications"}],frappe.help.help_links["List/Email Digest"]=[{label:"Email Digest",url:e+"user/manual/en/setting-up/email/email-digest"}],frappe.help.help_links["List/Auto Email Report"]=[{label:"Auto Email Reports",url:e+"user/manual/en/setting-up/email/email-reports"}],frappe.help.help_links["Form/Print Settings"]=[{label:"Print Settings",url:e+"user/manual/en/setting-up/print/print-settings"}],frappe.help.help_links["print-format-builder"]=[{label:"Print Format Builder",url:e+"user/manual/en/setting-up/print/print-settings"}],frappe.help.help_links["List/Print Heading"]=[{label:"Print Heading",url:e+"user/manual/en/setting-up/print/print-headings"}],frappe.help.help_links["Form/PayPal Settings"]=[{label:"PayPal Settings",url:e+"user/manual/en/setting-up/integrations/paypal-integration"}],frappe.help.help_links["Form/Razorpay Settings"]=[{label:"Razorpay Settings",url:e+"user/manual/en/setting-up/integrations/razorpay-integration"}],frappe.help.help_links["Form/Dropbox Settings"]=[{label:"Dropbox Settings",url:e+"user/manual/en/setting-up/integrations/dropbox-backup"}],frappe.help.help_links["Form/LDAP Settings"]=[{label:"LDAP Settings",url:e+"user/manual/en/setting-up/integrations/ldap-integration"}],frappe.help.help_links["Form/Stripe Settings"]=[{label:"Stripe Settings",url:e+"user/manual/en/setting-up/integrations/stripe-integration"}],frappe.help.help_links["Form/Quotation"]=[{label:"Quotation",url:e+"user/manual/en/selling/quotation"},{label:"Applying Discount",url:e+"user/manual/en/selling/articles/applying-discount"},{label:"Sales Person",url:e+"user/manual/en/selling/articles/sales-persons-in-the-sales-transactions"},{label:"Applying Margin",url:e+"user/manual/en/selling/articles/adding-margin"}],frappe.help.help_links["List/Customer"]=[{label:"Customer",url:e+"user/manual/en/CRM/customer"},{label:"Credit Limit",url:e+"user/manual/en/accounts/credit-limit"}],frappe.help.help_links["Form/Customer"]=[{label:"Customer",url:e+"user/manual/en/CRM/customer"},{label:"Credit Limit",url:e+"user/manual/en/accounts/credit-limit"}],frappe.help.help_links["List/Sales Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:e+"user/manual/en/setting-up/setting-up-taxes"}],frappe.help.help_links["Form/Sales Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:e+"user/manual/en/setting-up/setting-up-taxes"}],frappe.help.help_links["List/Sales Order"]=[{label:"Sales Order",url:e+"user/manual/en/selling/sales-order"},{label:"Recurring Sales Order",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"},{label:"Applying Discount",url:e+"user/manual/en/selling/articles/applying-discount"}],frappe.help.help_links["Form/Sales Order"]=[{label:"Sales Order",url:e+"user/manual/en/selling/sales-order"},{label:"Recurring Sales Order",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"},{label:"Applying Discount",url:e+"user/manual/en/selling/articles/applying-discount"},{label:"Drop Shipping",url:e+"user/manual/en/selling/articles/drop-shipping"},{label:"Sales Person",url:e+"user/manual/en/selling/articles/sales-persons-in-the-sales-transactions"},{label:"Close Sales Order",url:e+"user/manual/en/selling/articles/close-sales-order"},{label:"Applying Margin",url:e+"user/manual/en/selling/articles/adding-margin"}],frappe.help.help_links["Form/Product Bundle"]=[{label:"Product Bundle",url:e+"user/manual/en/selling/setup/product-bundle"}],frappe.help.help_links["Form/Selling Settings"]=[{label:"Selling Settings",url:e+"user/manual/en/selling/setup/selling-settings"}],frappe.help.help_links["List/Supplier"]=[{label:"Supplier",url:e+"user/manual/en/buying/supplier"}],frappe.help.help_links["Form/Supplier"]=[{label:"Supplier",url:e+"user/manual/en/buying/supplier"}],frappe.help.help_links["Form/Request for Quotation"]=[{label:"Request for Quotation",url:e+"user/manual/en/buying/request-for-quotation"},{label:"RFQ Video",url:e+"user/videos/learn/request-for-quotation.html"}],frappe.help.help_links["Form/Supplier Quotation"]=[{label:"Supplier Quotation",url:e+"user/manual/en/buying/supplier-quotation"}],frappe.help.help_links["Form/Buying Settings"]=[{label:"Buying Settings",url:e+"user/manual/en/buying/setup/buying-settings"}],frappe.help.help_links["List/Purchase Order"]=[{label:"Purchase Order",url:e+"user/manual/en/buying/purchase-order"},{label:"Recurring Purchase Order",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"}],frappe.help.help_links["Form/Purchase Order"]=[{label:"Purchase Order",url:e+"user/manual/en/buying/purchase-order"},{label:"Item UoM",url:e+"user/manual/en/buying/articles/purchasing-in-different-unit"},{label:"Supplier Item Code",url:e+"user/manual/en/buying/articles/maintaining-suppliers-part-no-in-item"},{label:"Recurring Purchase Order",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"},{label:"Subcontracting",url:e+"user/manual/en/manufacturing/subcontracting"}],frappe.help.help_links["List/Purchase Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:e+"user/manual/en/setting-up/setting-up-taxes"}],frappe.help.help_links["List/POS Profile"]=[{label:"POS Profile",url:e+"user/manual/en/setting-up/pos-setting"}],frappe.help.help_links["List/Price List"]=[{label:"Price List",url:e+"user/manual/en/setting-up/price-lists"}],frappe.help.help_links["List/Authorization Rule"]=[{label:"Authorization Rule",url:e+"user/manual/en/setting-up/authorization-rule"}],frappe.help.help_links["Form/SMS Settings"]=[{label:"SMS Settings",url:e+"user/manual/en/setting-up/sms-setting"}],frappe.help.help_links["List/Stock Reconciliation"]=[{label:"Stock Reconciliation",url:e+"user/manual/en/setting-up/stock-reconciliation-for-non-serialized-item"}],frappe.help.help_links["Tree/Territory"]=[{label:"Territory",url:e+"user/manual/en/setting-up/territory"}],frappe.help.help_links["Form/Dropbox Backup"]=[{label:"Dropbox Backup",url:e+"user/manual/en/setting-up/third-party-backups"},{label:"Setting Up Dropbox Backup",url:e+"user/manual/en/setting-up/articles/setting-up-dropbox-backups"}],frappe.help.help_links["List/Workflow"]=[{label:"Workflow",url:e+"user/manual/en/setting-up/workflows"}],frappe.help.help_links["List/Company"]=[{label:"Company",url:e+"user/manual/en/setting-up/company-setup"},{label:"Managing Multiple Companies",url:e+"user/manual/en/setting-up/articles/managing-multiple-companies"},{label:"Delete All Related Transactions for a Company",url:e+"user/manual/en/setting-up/articles/delete-a-company-and-all-related-transactions"}],frappe.help.help_links["modules/Accounts"]=[{label:"Introduction to Accounts",url:e+"user/manual/en/accounts/"},{label:"Chart of Accounts",url:e+"user/manual/en/accounts/chart-of-accounts.html"},{label:"Multi Currency Accounting",url:e+"user/manual/en/accounts/multi-currency-accounting"}],frappe.help.help_links["Tree/Account"]=[{label:"Chart of Accounts",url:e+"user/manual/en/accounts/chart-of-accounts"},{label:"Managing Tree Mastes",url:e+"user/manual/en/setting-up/articles/managing-tree-structure-masters"}],frappe.help.help_links["Form/Sales Invoice"]=[{label:"Sales Invoice",url:e+"user/manual/en/accounts/sales-invoice"},{label:"Accounts Opening Balance",url:e+"user/manual/en/accounts/opening-accounts"},{label:"Sales Return",url:e+"user/manual/en/stock/sales-return"},{label:"Recurring Sales Invoice",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"}],frappe.help.help_links["List/Sales Invoice"]=[{label:"Sales Invoice",url:e+"user/manual/en/accounts/sales-invoice"},{label:"Accounts Opening Balance",url:e+"user/manual/en/accounts/opening-accounts"},{label:"Sales Return",url:e+"user/manual/en/stock/sales-return"},{label:"Recurring Sales Invoice",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"}],frappe.help.help_links.pos=[{label:"Point of Sale Invoice",url:e+"user/manual/en/accounts/point-of-sale-pos-invoice"}],frappe.help.help_links["List/POS Profile"]=[{label:"Point of Sale Profile",url:e+"user/manual/en/setting-up/pos-setting"}],frappe.help.help_links["List/Purchase Invoice"]=[{label:"Purchase Invoice",url:e+"user/manual/en/accounts/purchase-invoice"},{label:"Accounts Opening Balance",url:e+"user/manual/en/accounts/opening-accounts"},{label:"Recurring Purchase Invoice",url:e+"user/manual/en/accounts/recurring-orders-and-invoices"}],frappe.help.help_links["List/Journal Entry"]=[{label:"Journal Entry",url:e+"user/manual/en/accounts/journal-entry"},{label:"Advance Payment Entry",url:e+"user/manual/en/accounts/advance-payment-entry"},{label:"Accounts Opening Balance",url:e+"user/manual/en/accounts/opening-accounts"}],frappe.help.help_links["List/Payment Entry"]=[{label:"Payment Entry",url:e+"user/manual/en/accounts/payment-entry"}],frappe.help.help_links["List/Payment Request"]=[{label:"Payment Request",url:e+"user/manual/en/accounts/payment-request"}],frappe.help.help_links["List/Asset"]=[{label:"Managing Fixed Assets",url:e+"user/manual/en/accounts/managing-fixed-assets"}],frappe.help.help_links["List/Asset Category"]=[{label:"Asset Category",url:e+"user/manual/en/accounts/managing-fixed-assets"}],frappe.help.help_links["Tree/Cost Center"]=[{label:"Budgeting",url:e+"user/manual/en/accounts/budgeting"}],frappe.help.help_links["List/Item"]=[{label:"Item",url:e+"user/manual/en/stock/item"},{label:"Item Price",url:e+"user/manual/en/stock/item/item-price"},{label:"Barcode",url:e+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Item Wise Taxation",url:e+"user/manual/en/accounts/item-wise-taxation"},{label:"Managing Fixed Assets",url:e+"user/manual/en/accounts/managing-fixed-assets"},{label:"Item Codification",url:e+"user/manual/en/stock/item/item-codification"},{label:"Item Variants",url:e+"user/manual/en/stock/item/item-variants"},{label:"Item Valuation",url:e+"user/manual/en/stock/item/item-valuation-fifo-and-moving-average"}],frappe.help.help_links["Form/Item"]=[{label:"Item",url:e+"user/manual/en/stock/item"},{label:"Item Price",url:e+"user/manual/en/stock/item/item-price"},{label:"Barcode",url:e+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Item Wise Taxation",url:e+"user/manual/en/accounts/item-wise-taxation"},{label:"Managing Fixed Assets",url:e+"user/manual/en/accounts/managing-fixed-assets"},{label:"Item Codification",url:e+"user/manual/en/stock/item/item-codification"},{label:"Item Variants",url:e+"user/manual/en/stock/item/item-variants"},{label:"Item Valuation",url:e+"user/manual/en/stock/item/item-valuation-fifo-and-moving-average"}],frappe.help.help_links["List/Purchase Receipt"]=[{label:"Purchase Receipt",url:e+"user/manual/en/stock/purchase-receipt"},{label:"Barcode",url:e+"user/manual/en/stock/articles/track-items-using-barcode"}],frappe.help.help_links["List/Delivery Note"]=[{label:"Delivery Note",url:e+"user/manual/en/stock/delivery-note"},{label:"Barcode",url:e+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Sales Return",url:e+"user/manual/en/stock/sales-return"}],frappe.help.help_links["Form/Delivery Note"]=[{label:"Delivery Note",url:e+"user/manual/en/stock/delivery-note"},{label:"Sales Return",url:e+"user/manual/en/stock/sales-return"},{label:"Barcode",url:e+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Subcontracting",url:e+"user/manual/en/manufacturing/subcontracting"}],frappe.help.help_links["List/Installation Note"]=[{label:"Installation Note",url:e+"user/manual/en/stock/installation-note"}],frappe.help.help_links.Tree=[{label:"Managing Tree Structure Masters",url:e+"user/manual/en/setting-up/articles/managing-tree-structure-masters"}],frappe.help.help_links["List/Budget"]=[{label:"Budgeting",url:e+"user/manual/en/accounts/budgeting"}],frappe.help.help_links["List/Material Request"]=[{label:"Material Request",url:e+"user/manual/en/stock/material-request"},{label:"Auto-creation of Material Request",url:e+"user/manual/en/stock/articles/auto-creation-of-material-request"}],frappe.help.help_links["Form/Material Request"]=[{label:"Material Request",url:e+"user/manual/en/stock/material-request"},{label:"Auto-creation of Material Request",url:e+"user/manual/en/stock/articles/auto-creation-of-material-request"}],frappe.help.help_links["Form/Stock Entry"]=[{label:"Stock Entry",url:e+"user/manual/en/stock/stock-entry"},{label:"Stock Entry Types",url:e+"user/manual/en/stock/articles/stock-entry-purpose"},{label:"Repack Entry",url:e+"user/manual/en/stock/articles/repack-entry"},{label:"Opening Stock",url:e+"user/manual/en/stock/opening-stock"},{label:"Subcontracting",url:e+"user/manual/en/manufacturing/subcontracting"}],frappe.help.help_links["List/Stock Entry"]=[{label:"Stock Entry",url:e+"user/manual/en/stock/stock-entry"}],frappe.help.help_links["Tree/Warehouse"]=[{label:"Warehouse",url:e+"user/manual/en/stock/warehouse"}],frappe.help.help_links["List/Serial No"]=[{label:"Serial No",url:e+"user/manual/en/stock/serial-no"}],frappe.help.help_links["Form/Serial No"]=[{label:"Serial No",url:e+"user/manual/en/stock/serial-no"}],frappe.help.help_links["Form/Batch"]=[{label:"Batch",url:e+"user/manual/en/stock/batch"}],frappe.help.help_links["Form/Packing Slip"]=[{label:"Packing Slip",url:e+"user/manual/en/stock/tools/packing-slip"}],frappe.help.help_links["Form/Quality Inspection"]=[{label:"Quality Inspection",url:e+"user/manual/en/stock/tools/quality-inspection"}],frappe.help.help_links["Form/Landed Cost Voucher"]=[{label:"Landed Cost Voucher",url:e+"user/manual/en/stock/tools/landed-cost-voucher"}],frappe.help.help_links["Tree/Item Group"]=[{label:"Item Group",url:e+"user/manual/en/stock/setup/item-group"}],frappe.help.help_links["Form/Item Attribute"]=[{label:"Item Attribute",url:e+"user/manual/en/stock/setup/item-attribute"}],frappe.help.help_links["Form/UOM"]=[{label:"Fractions in UOM",url:e+"user/manual/en/stock/articles/managing-fractions-in-uom"}],frappe.help.help_links["Form/Stock Reconciliation"]=[{label:"Opening Stock Entry",url:e+"user/manual/en/stock/opening-stock"}],frappe.help.help_links["Form/Lead"]=[{label:"Lead",url:e+"user/manual/en/CRM/lead"}],frappe.help.help_links["Form/Opportunity"]=[{label:"Opportunity",url:e+"user/manual/en/CRM/opportunity"}],frappe.help.help_links["Form/Address"]=[{label:"Address",url:e+"user/manual/en/CRM/contact"}],frappe.help.help_links["Form/Contact"]=[{label:"Contact",url:e+"user/manual/en/CRM/contact"}],frappe.help.help_links["Form/Newsletter"]=[{label:"Newsletter",url:e+"user/manual/en/CRM/newsletter"}],frappe.help.help_links["Form/Campaign"]=[{label:"Campaign",url:e+"user/manual/en/CRM/setup/campaign"}],frappe.help.help_links["Tree/Sales Person"]=[{label:"Sales Person",url:e+"user/manual/en/CRM/setup/sales-person"}],frappe.help.help_links["Form/Sales Person"]=[{label:"Sales Person Target",url:e+"user/manual/en/selling/setup/sales-person-target-allocation"}],frappe.help.help_links["List/Feedback Trigger"]=[{label:"Feedback Trigger",url:e+"user/manual/en/setting-up/feedback/setting-up-feedback"}],frappe.help.help_links["List/Feedback Request"]=[{label:"Feedback Request",url:e+"user/manual/en/setting-up/feedback/submit-feedback"}],frappe.help.help_links["List/Feedback Request"]=[{label:"Feedback Request",url:e+"user/manual/en/setting-up/feedback/submit-feedback"}],frappe.help.help_links["Form/BOM"]=[{label:"Bill of Material",url:e+"user/manual/en/manufacturing/bill-of-materials"},{label:"Nested BOM Structure",url:e+"user/manual/en/manufacturing/articles/nested-bom-structure"}],frappe.help.help_links["Form/Work Order"]=[{label:"Work Order",url:e+"user/manual/en/manufacturing/work-order"}],frappe.help.help_links["Form/Workstation"]=[{label:"Workstation",url:e+"user/manual/en/manufacturing/workstation"}],frappe.help.help_links["Form/Operation"]=[{label:"Operation",url:e+"user/manual/en/manufacturing/operation"}],frappe.help.help_links["Form/BOM Update Tool"]=[{label:"BOM Update Tool",url:e+"user/manual/en/manufacturing/tools/bom-update-tool"}],frappe.help.help_links["Form/Customize Form"]=[{label:"Custom Field",url:e+"user/manual/en/customize-erpnext/custom-field"},{label:"Customize Field",url:e+"user/manual/en/customize-erpnext/customize-form"}],frappe.help.help_links["Form/Custom Field"]=[{label:"Custom Field",url:e+"user/manual/en/customize-erpnext/custom-field"}],frappe.help.help_links["Form/Custom Field"]=[{label:"Custom Field",url:e+"user/manual/en/customize-erpnext/custom-field"}],frappe.provide("agriculture"),agriculture.TernaryPlot=class{constructor(e){var t=this;Object.assign(this,e),frappe.require("assets/frappe/js/lib/snap.svg-min.js",function(){t.make_svg(),t.init_snap(),t.init_config(),t.make_plot(),t.make_plot_marking(),t.make_legend(),t.mark_blip()})}make_svg(){this.$svg=$('<svg height="350" width="400">'),$(this.parent).append(this.$svg)}init_snap(){this.paper=new Snap(this.$svg.get(0))}init_config(){this.config={triangle_side:300,spacing:50,strokeWidth:1,stroke:frappe.ui.color.get("black")},this.config.scaling_factor=this.config.triangle_side/100;var e=this.config,t=e.triangle_side,a=e.spacing,r=e.scaling_factor;this.coords={sand:{points:[a+t*Snap.cos(60),a,a,a+t*Snap.cos(30),a+t,a+t*Snap.cos(30)],color:frappe.ui.color.get("peach")},loamy_sand:{points:[a+15*r*Snap.cos(60),a+85*r*Snap.cos(30),a+10*r*Snap.cos(60),a+90*r*Snap.cos(30),a+15*r,a+t*Snap.cos(30),a+30*r,a+t*Snap.cos(30)],color:frappe.ui.color.get("pink")},sandy_loam:{points:[a+20*r*Snap.cos(60)+27.5*r,a+80*r*Snap.cos(30),a+20*r*Snap.cos(60),a+80*r*Snap.cos(30),a+15*r*Snap.cos(60),a+85*r*Snap.cos(30),a+25*r,a+t*Snap.cos(30),a+50*r,a+t*Snap.cos(30),a+50*r+7.5*r*Snap.cos(60),a+t*Snap.cos(30)-7.5*r*Snap.cos(30),a+50*r+7.5*r*Snap.cos(60)-10*r,a+t*Snap.cos(30)-7.5*r*Snap.cos(30)],color:frappe.ui.color.get("pink","light")},loam:{points:[a+50*r+27.5*r*Snap.cos(60),a+t*Snap.cos(30)-27.5*r*Snap.cos(30),a+50*r+27.5*r*Snap.cos(60)-22.5*r,a+t*Snap.cos(30)-27.5*r*Snap.cos(30),a+20*r*Snap.cos(60)+27.5*r,a+80*r*Snap.cos(30),a+50*r+7.5*r*Snap.cos(60)-10*r,a+t*Snap.cos(30)-7.5*r*Snap.cos(30),a+50*r+7.5*r*Snap.cos(60),a+t*Snap.cos(30)-7.5*r*Snap.cos(30)],color:frappe.ui.color.get("brown")},silt_loam:{points:[a+t-27.5*r*Snap.cos(60),a+72.5*r*Snap.cos(30),a+50*r+27.5*r*Snap.cos(60),a+t*Snap.cos(30)-27.5*r*Snap.cos(30),a+50*r,a+t*Snap.cos(30),a+80*r,a+t*Snap.cos(30),a+80*r+12.5*r*Snap.cos(60),a+90*r*Snap.cos(30),a+t-12.5*r*Snap.cos(60),a+87.5*r*Snap.cos(30)],color:frappe.ui.color.get("green","dark")},silt:{points:[a+t-12.5*r*Snap.cos(60),a+87.5*r*Snap.cos(30),a+80*r+12.5*r*Snap.cos(60),a+90*r*Snap.cos(30),a+80*r,a+t*Snap.cos(30),a+t,a+t*Snap.cos(30)],color:frappe.ui.color.get("green")},silty_clay_loam:{points:[a+t-40*r*Snap.cos(60),a+60*r*Snap.cos(30),a+t-40*r*Snap.cos(60)-20*r,a+60*r*Snap.cos(30),a+t-27.5*r*Snap.cos(60)-20*r,a+72.5*r*Snap.cos(30),a+t-27.5*r*Snap.cos(60),a+72.5*r*Snap.cos(30)],color:frappe.ui.color.get("cyan","dark")},silty_clay:{points:[a+t-60*r*Snap.cos(60),a+40*r*Snap.cos(30),a+t-40*r*Snap.cos(60)-20*r,a+60*r*Snap.cos(30),a+t-40*r*Snap.cos(60),a+60*r*Snap.cos(30)],color:frappe.ui.color.get("cyan")},clay_loam:{points:[a+t-40*r*Snap.cos(60)-20*r,a+60*r*Snap.cos(30),a+t-40*r*Snap.cos(60)-45*r,a+60*r*Snap.cos(30),a+t-27.5*r*Snap.cos(60)-45*r,a+72.5*r*Snap.cos(30),a+t-27.5*r*Snap.cos(60)-20*r,a+72.5*r*Snap.cos(30)],color:frappe.ui.color.get("green","light")},sandy_clay_loam:{points:[a+35*r*Snap.cos(60)+20*r,a+65*r*Snap.cos(30),a+35*r*Snap.cos(60),a+65*r*Snap.cos(30),a+20*r*Snap.cos(60),a+80*r*Snap.cos(30),a+20*r*Snap.cos(60)+27.5*r,a+80*r*Snap.cos(30),a+t-27.5*r*Snap.cos(60)-45*r,a+72.5*r*Snap.cos(30)],color:frappe.ui.color.get("pink","dark")},sandy_clay:{points:[a+55*r*Snap.cos(60),a+45*r*Snap.cos(30),a+35*r*Snap.cos(60),a+65*r*Snap.cos(30),a+35*r*Snap.cos(60)+20*r,a+65*r*Snap.cos(30)],color:frappe.ui.color.get("red")},clay:{points:[a+t*Snap.cos(60),a,a+55*r*Snap.cos(60),a+45*r*Snap.cos(30),a+t-40*r*Snap.cos(60)-45*r,a+60*r*Snap.cos(30),a+t-40*r*Snap.cos(60)-20*r,a+60*r*Snap.cos(30),a+t-60*r*Snap.cos(60),a+40*r*Snap.cos(30)],color:frappe.ui.color.get("yellow")}}}get_coords(e){return this.coords[e].points}get_color(e){return this.coords[e].color}make_plot(){for(var e in this.coords)this.paper.polygon(this.get_coords(e)).attr({fill:this.get_color(e),stroke:this.config.stroke,strokeWidth:this.config.strokeWidth})}make_plot_marking(){var e=this.config,t=e.triangle_side,a=e.spacing;e.scaling_factor;this.paper.text(t*Snap.cos(60)/2,a+t*Snap.cos(30)/2,__("Clay")).attr({fill:frappe.ui.color.get("black")}).transform("r300"),this.paper.text(t,a+t*Snap.cos(30)/2,__("Silt")).attr({fill:frappe.ui.color.get("black")}).transform("r60"),this.paper.text(35+t*Snap.cos(60),90+t*Snap.cos(30),__("Sand")).attr({fill:frappe.ui.color.get("black")}).transform("r0")}make_legend(){var e=1,t=0,a=!0;for(var r in this.coords){e>6&&a&&(t=300,e=1,a=!1);this.paper.rect(0+t,0+20*e,100,19,5,5).attr({fill:this.get_color(r),stroke:frappe.ui.color.get("black")}),this.paper.text(5+t,16+20*e,r).attr({fill:frappe.ui.color.get("black"),"font-size":12});e++}}mark_blip(e){void 0===e&&(e=this);var t=e.clay,a=e.sand,r=e.silt;if(t+a+r!=0){var i=this.config,n=(i.triangle_side,i.spacing),s=i.scaling_factor,o=n+t*s*Snap.cos(60)+r*s,c=n+r*s*Snap.cos(30)+a*s*Snap.sin(60);this.blip=this.paper.circle(o,c,4).attr({fill:frappe.ui.color.get("orange"),stroke:frappe.ui.color.get("orange"),strokeWidth:2})}}remove_blip(){void 0!==this.blip&&this.blip.remove()}},frappe.templates.item_quick_entry='<div class="h6 uppercase" style="margin-top: 30px;">{{ __("Variant Attributes") }}</div> <div class="attributes hide-control"> </div>',frappe.provide("frappe.ui.form"),frappe.ui.form.ItemQuickEntryForm=frappe.ui.form.QuickEntryForm.extend({init:function(e,t){this._super(e,t)},render_dialog:function(){this.mandatory=this.get_variant_fields().concat(this.mandatory),this.mandatory=this.mandatory.concat(this.get_attributes_fields()),this.check_naming_series_based_on(),this._super(),this.init_post_render_dialog_operations(),this.preset_fields_for_template(),this.dialog.$wrapper.find(".edit-full").text(__("Edit in full page for more options like assets, serial nos, batches etc."))},check_naming_series_based_on:function(){"Naming Series"===frappe.defaults.get_default("item_naming_by")&&(this.mandatory=this.mandatory.filter(function(e){return"item_code"!==e.fieldname}))},init_post_render_dialog_operations:function(){this.dialog.fields_dict.attribute_html.$wrapper.append(frappe.render_template("item_quick_entry")),this.init_for_create_variant_trigger(),this.init_for_item_template_trigger(),this.toggle_manufacturer_fields(),this.dialog.get_field("item_template").df.hidden=1,this.dialog.get_field("item_template").refresh()},register_primary_action:function(){var e=this;this.dialog.set_primary_action(__("Save"),function(){if(!e.dialog.working){var t=e.dialog.get_values(),a={};if(e.dialog.fields_dict.create_variant.$input.prop("checked")&&(a=e.get_variant_doc(),Object.keys(a).length||(t=null),a.stock_uom=e.template_doc.stock_uom,a.item_group=e.template_doc.item_group),t){e.dialog.working=!0;var r=e.update_doc();"Manufacturer"==a.variant_based_on&&(r.variant_based_on="Manufacturer"),$.extend(a,r),e.insert(a)}}})},insert:function(e){var t=this;return new Promise(function(a){frappe.call({method:"frappe.client.insert",args:{doc:e},callback:function(e){t.dialog.hide(),frappe.model.clear_doc(t.dialog.doc.doctype,t.dialog.doc.name),t.dialog.doc=e.message,frappe._from_link?frappe.ui.form.update_calling_link(t.dialog.doc):t.after_insert?t.after_insert(t.dialog.doc):t.open_form_if_not_list()},error:function(){t.open_doc()},always:function(){t.dialog.working=!1,a(t.dialog.doc)},freeze:!0})})},open_doc:function(){if(this.dialog.hide(),this.update_doc(),this.dialog.fields_dict.create_variant.$input.prop("checked")){var e=this.dialog.fields_dict.item_template.input.value;e&&frappe.set_route("Form",this.doctype,e)}else frappe.set_route("Form",this.doctype,this.doc.name)},get_variant_fields:function(){return[{fieldname:"create_variant",fieldtype:"Check",label:__("Create Variant")},{fieldname:"item_template",label:__("Item Template"),reqd:0,fieldtype:"Link",options:"Item",get_query:function(){return{filters:{has_variants:1}}}}]},get_manufacturing_fields:function(){return this.manufacturer_fields=[{fieldtype:"Link",options:"Manufacturer",label:"Manufacturer",fieldname:"manufacturer",hidden:1,reqd:0},{fieldtype:"Data",label:"Manufacturer Part Number",fieldname:"manufacturer_part_no",hidden:1,reqd:0}],this.manufacturer_fields},get_attributes_fields:function(){var e=[{fieldname:"attribute_html",fieldtype:"HTML"}];return e=e.concat(this.get_manufacturing_fields())},init_for_create_variant_trigger:function(){var e=this;this.dialog.fields_dict.create_variant.$input.on("click",function(){e.preset_fields_for_template(),e.init_post_template_trigger_operations(!1,[],!0)})},preset_fields_for_template:function(){var e=this,t=this.dialog.get_value("create_variant"),a=this.dialog.get_field("item_template");a.df.reqd=t,a.set_value(""),a.df.hidden=!t,a.refresh(),["item_code","item_name","item_group","stock_uom"].forEach(function(a){var r=e.dialog.get_field(a);r.df.hidden=t,r.refresh()}),this.dialog.get_field("attribute_html").toggle(!1),["item_code","stock_uom","item_group"].forEach(function(a){var r=e.dialog.get_field(a);r.df.reqd=!t,r.refresh()})},init_for_item_template_trigger:function(){var e=this;e.dialog.fields_dict.item_template.df.onchange=function(){var t=e.dialog.fields_dict.item_template.input.value;e.template_doc=null,t?frappe.call({method:"frappe.client.get",args:{doctype:"Item",name:t},callback:function(t){e.template_doc=t.message,e.is_manufacturer=!1,"Manufacturer"===e.template_doc.variant_based_on?e.init_post_template_trigger_operations(!0,[],!0):(e.init_post_template_trigger_operations(!1,e.template_doc.attributes,!1),e.render_attributes(e.template_doc.attributes))}}):(e.dialog.get_field("attribute_html").toggle(!1),e.init_post_template_trigger_operations(!1,[],!0))}},init_post_template_trigger_operations:function(e,t,a){this.attributes=t,this.attribute_values={},this.attributes_count=t.length,this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes").empty(),this.is_manufacturer=e,this.toggle_manufacturer_fields(),this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes").toggleClass("hide-control",a),this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes-header").toggleClass("hide-control",a)},toggle_manufacturer_fields:function(){var e=this;$.each(this.manufacturer_fields,function(t,a){e.dialog.get_field(a.fieldname).df.hidden=!e.is_manufacturer,e.dialog.get_field(a.fieldname).df.reqd="manufacturer"==a.fieldname&&e.is_manufacturer,e.dialog.get_field(a.fieldname).refresh()})},initiate_render_attributes:function(){this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes").empty(),this.render_attributes(this.attributes)},render_attributes:function(e){var t=this;this.dialog.get_field("attribute_html").toggle(!0),$.each(e,function(e,a){var r="",i="Data";a.numeric_values&&(i="Float",r="Min Value: "+a.from_range+" , Max Value: "+a.to_range+", in Increments of: "+a.increment),t.init_make_control(i,a),t[a.attribute].set_value(t.attribute_values[a.attribute]||""),t[a.attribute].$wrapper.toggleClass("has-error",!t.attribute_values[a.attribute]),$(t[a.attribute].label_area).text(__(a.attribute)),r&&$(repl('<p class="help-box small text-muted hidden-xs">%(desc)s</p>',{desc:r})).insertAfter(t[a.attribute].input_area),a.numeric_values?t[a.attribute].$input.on("change",function(){t.attribute_values[a.attribute]=$(this).val(),$(this).closest(".frappe-control").toggleClass("has-error",!$(this).val())}):t.init_awesomplete_for_attribute(a)})},init_make_control:function(e,t){this[t.attribute]=frappe.ui.form.make_control({df:{fieldtype:e,label:t.attribute,fieldname:t.attribute,options:t.options||""},parent:$(this.dialog.fields_dict.attribute_html.wrapper).find(".attributes"),only_input:!1}),this[t.attribute].make_input()},init_awesomplete_for_attribute:function(e){var t=this;this[e.attribute].input.awesomplete=new Awesomplete(this[e.attribute].input,{minChars:0,maxItems:99,autoFirst:!0,list:[]}),this[e.attribute].$input.on("input",function(e){frappe.call({method:"frappe.client.get_list",args:{doctype:"Item Attribute Value",filters:[["parent","=",$(e.target).attr("data-fieldname")],["attribute_value","like",e.target.value+"%"]],fields:["attribute_value"],parent:"Item Attribute"},callback:function(t){t.message&&(e.target.awesomplete.list=t.message.map(function(e){return e.attribute_value}))}})}).on("focus",function(e){$(e.target).val("").trigger("input")}).on("awesomplete-close",function(e){t.attribute_values[$(e.target).attr("data-fieldname")]=e.target.value,$(e.target).closest(".frappe-control").toggleClass("has-error",!e.target.value)})},get_variant_doc:function(){var e=this,t={},a=this.validate_mandatory_attributes();return Object.keys(a).length&&frappe.call({method:"erpnext.controllers.item_variant.create_variant_doc_for_quick_entry",args:{template:e.dialog.fields_dict.item_template.$input.val(),args:a},async:!1,callback:function(a){if("[object Object]"==Object.prototype.toString.call(a.message))t=a.message;else{var r=frappe.msgprint(__("Item Variant {0} already exists with same attributes",[repl('<a class="strong variant-click" data-item-code="%(item)s" \t\t\t\t\t\t\t\t>%(item)s</a>',{item:a.message})]));r.$wrapper.find(".variant-click").on("click",function(){r.hide(),e.dialog.hide(),frappe._from_link?frappe._from_link.set_value($(this).attr("data-item-code")):frappe.set_route("Form","Item",$(this).attr("data-item-code"))})}}}),t},validate_mandatory_attributes:function(){var e=this,t={},a=[];return $.each(this.attributes,function(r,i){var n=e.attribute_values[i.attribute]||"";n?t[i.attribute]=i.numeric_values?flt(n):n:a.push(i.attribute)}),this.is_manufacturer&&$.each(this.manufacturer_fields,function(a,r){t[r.fieldname]=e.dialog.fields_dict[r.fieldname].input.value}),t}}),frappe.provide("frappe.ui.form"),frappe.ui.form.CustomerQuickEntryForm=frappe.ui.form.QuickEntryForm.extend({init:function(e,t){this.skip_redirect_on_error=!0,this._super(e,t)},render_dialog:function(){this.mandatory=this.mandatory.concat(this.get_variant_fields()),this._super()},get_variant_fields:function(){return[{fieldtype:"Section Break",label:__("Primary Contact Details"),collapsible:1},{label:__("Email Id"),fieldname:"email_id",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("Mobile Number"),fieldname:"mobile_no",fieldtype:"Data"},{fieldtype:"Section Break",label:__("Primary Address Details"),collapsible:1},{label:__("Address Line 1"),fieldname:"address_line1",fieldtype:"Data"},{label:__("Address Line 2"),fieldname:"address_line2",fieldtype:"Data"},{label:__("ZIP Code"),fieldname:"pincode",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("City"),fieldname:"city",fieldtype:"Data"},{label:__("State"),fieldname:"state",fieldtype:"Data"},{label:__("Country"),fieldname:"country",fieldtype:"Link",options:"Country"},{label:__("Customer POS Id"),fieldname:"customer_pos_id",fieldtype:"Data",hidden:1}]}}),frappe.templates.student_button='<div class="col-sm-3">     <div class="checkbox">         <label>             <input                  type="checkbox"                 data-group_roll_number="{{group_roll_number}}"                  data-student="{{student}}"                 data-student-name="{{student_name}}"                 class="students-check"                  {% if status === "Present" %}                 checked                 {% endif %}                 >             {{ group_roll_number }} - {{ student_name }}         </label>     </div> </div>',frappe.templates.assessment_result_tool='<table class="table table-bordered assessment-result-tool">  <thead>   <tr>    <th style="width: 90px" rowspan="2">Student</th>    <th style="width: 170px" rowspan="2">Student Name</th>    {% for c in criteria %}    <th class="score" style="width: 100px">{{ c.assessment_criteria }}</th>    {% endfor %}    <th class="score" style="width: 170px" rowspan="2">Comments</th>    <th class="score" style="width: 100px">Total Marks</th>       </tr>   <tr>    {% for c in criteria %}    <th class="score" style="width: 100px">Score ({{ c.maximum_score }})</th>    {% endfor %}    <th class="score" style="width: 100px">Score ({{max_total_score}})</th>   </tr>  </thead>  <tbody>   {% for s in students %}   <tr     {% if(s.assessment_details && s.docstatus && s.docstatus == 1) { %} class="text-muted" {% } %}    data-student="{{s.student}}">     <td>{{ s.student }}</td>    <td>{{ s.student_name }}</td>    {% for c in criteria %}    <td>     <span data-student="{{s.student}}" data-criteria="{{c.assessment_criteria}}" class="student-result-grade badge" >      {% if(s.assessment_details) { %}       {{s.assessment_details[c.assessment_criteria][1]}}       {% } %}     </span>     <input type="number" class="student-result-data" style="width:70%; float:right;"      data-max-score="{{c.maximum_score}}"      data-criteria="{{c.assessment_criteria}}"      data-student="{{s.student}}"      {% if(s.assessment_details && s.docstatus && s.docstatus == 1) { %} disabled {% } %}      {% if(s.assessment_details) { %}       value="{{s.assessment_details[c.assessment_criteria][0]}}"      {% } %}/>    </td>    {% endfor %}    <td>     <input type="text" class="result-comment" data-student="{{s.student}}"     {% if(s.assessment_details && s.docstatus && s.docstatus == 1) { %} disabled {% } %}     {% if(s.assessment_details) { %}      value="{{s.assessment_details.comment}}"     {% } %}    </td>    <td>     <span data-student="{{s.student}}" class="total-score-grade badge" style="width:30%; float:left;">     {% if(s.assessment_details) { %}     {{s.assessment_details.total_score[1]}}     {% } %}     </span>     <span data-student="{{s.student}}" class="total-score" style="width:60%; float:center;">     {% if(s.assessment_details) { %}     {{s.assessment_details.total_score[0]}}     {% } %}     </span>     <span data-student="{{s.student}}" class="total-result-link" style="width: 10%; display:{% if(!s.assessment_details) { %}None{% } %}; float:right;">      <a class="btn-open no-decoration" title="Open Link" href="#Form/Assessment Result/{% if(s.assessment_details) { %}{{s.name}}{% } %}">       <i class="octicon octicon-arrow-right"></i>      </a>     </span>    </td>   </tr>   {% endfor %}  </tbody> </table>',frappe.provide("erpnext.hub"),frappe.views.MarketplaceFactory=class extends frappe.views.Factory{show(){var e=this;frappe.call({method:"erpnext.hub_node.doctype.marketplace_settings.marketplace_settings.is_marketplace_enabled"}).then(function(e){return e.message}).then(function(t){t?frappe.show_not_found("Marketplace"):frappe.pages.marketplace?(frappe.container.change_to("marketplace"),erpnext.hub.marketplace.refresh()):e.make("marketplace")})}make(e){var t=this;frappe.require(["/assets/js/marketplace.min.js"],function(){erpnext.hub.marketplace=new erpnext.hub.Marketplace({parent:t.make_page(!0,e)})})}};class t{constructor(e){this.caller_number=e.from,this.call_log=e,this.setup_listener(),this.make()}make(){var e=this;this.dialog=new frappe.ui.Dialog({static:!0,minimizable:!0,fields:[{fieldname:"name",label:"Name",default:this.get_caller_name()||__("Unknown Caller"),fieldtype:"Data",read_only:1},{fieldtype:"Button",label:__("Open Contact"),click:function(){return frappe.set_route("Form","Contact",e.call_log.contact)},depends_on:function(){return e.call_log.contact}},{fieldtype:"Button",label:__("Open Lead"),click:function(){return frappe.set_route("Form","Lead",e.call_log.lead)},depends_on:function(){return e.call_log.lead}},{fieldtype:"Button",label:__("Create New Contact"),click:function(){return frappe.new_doc("Contact",{mobile_no:e.caller_number})},depends_on:function(){return!e.get_caller_name()}},{fieldtype:"Button",label:__("Create New Lead"),click:function(){return frappe.new_doc("Lead",{mobile_no:e.caller_number})},depends_on:function(){return!e.get_caller_name()}},{fieldtype:"Column Break"},{fieldname:"number",label:"Phone Number",fieldtype:"Data",default:this.caller_number,read_only:1},{fielname:"last_interaction",fieldtype:"Section Break",label:__("Activity"),depends_on:function(){return e.get_caller_name()}},{fieldtype:"Small Text",label:__("Last Issue"),fieldname:"last_issue",read_only:!0,depends_on:function(){return e.call_log.contact},default:'<i class="text-muted">'+__("No issue has been raised by the caller.")+"<i>"},{fieldtype:"Small Text",label:__("Last Communication"),fieldname:"last_communication",read_only:!0,default:'<i class="text-muted">'+__("No communication found.")+"<i>"},{fieldtype:"Section Break"},{fieldtype:"Small Text",label:__("Call Summary"),fieldname:"call_summary"},{fieldtype:"Button",label:__("Save"),click:function(){var t=e.dialog.get_value("call_summary");t&&frappe.xcall("erpnext.communication.doctype.call_log.call_log.add_call_summary",{call_log:e.call_log.name,summary:t}).then(function(){e.close_modal(),frappe.show_alert({message:"\n\t\t\t\t\t\t\t\t"+__("Call Summary Saved")+'\n\t\t\t\t\t\t\t\t<br>\n\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\tclass="text-small text-muted"\n\t\t\t\t\t\t\t\t\thref="#Form/Call Log/'+e.call_log.name+'">\n\t\t\t\t\t\t\t\t\t'+__("View call log")+"\n\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t",indicator:"green"})})}}]}),this.set_call_status(),this.dialog.get_close_btn().show(),this.make_last_interaction_section(),this.dialog.$body.addClass("call-popup"),this.dialog.set_secondary_action(this.close_modal.bind(this)),frappe.utils.play_sound("incoming-call"),this.dialog.show()}set_indicator(e,t){void 0===t&&(t=!1);var a="indicator "+e+" "+(t?"blink":"");this.dialog.header.find(".indicator").attr("class",a)}set_call_status(e){var t="";e=e||this.call_log.status,["Ringing"].includes(e)||!e?(t=__("Incoming call from {0}",[this.get_caller_name()||this.caller_number]),this.set_indicator("blue",!0)):"In Progress"===e?(t=__("Call Connected"),this.set_indicator("yellow")):"Missed"===e?(this.set_indicator("red"),t=__("Call Missed")):["Completed","Disconnected"].includes(e)?(this.set_indicator("red"),t=__("Call Disconnected")):(this.set_indicator("blue"),t=e),this.dialog.set_title(t)}update_call_log(e){this.call_log=e,this.set_call_status()}close_modal(){this.dialog.hide(),delete erpnext.call_popup}call_disconnected(e){var t=this;frappe.utils.play_sound("call-disconnect"),this.update_call_log(e),setTimeout(function(){t.dialog.get_value("call_summary")||t.close_modal()},3e4)}make_last_interaction_section(){var e=this;frappe.xcall("erpnext.crm.doctype.utils.get_last_interaction",{contact:this.call_log.contact,lead:this.call_log.lead}).then(function(t){var a=e.dialog.get_field("last_communication");if(t.last_communication){var r=t.last_communication;a.set_value(r.content)}if(t.last_issue){var i=t.last_issue,n=e.dialog.get_field("last_issue");n.set_value(i.subject),n.$wrapper.append('\n\t\t\t\t\t<a class="text-medium" href="#List/Issue?customer='+i.customer+'">\n\t\t\t\t\t\t'+__("View all issues from {0}",[i.customer])+"\n\t\t\t\t\t</a>\n\t\t\t\t")}})}get_caller_name(){var e=this.call_log;return e.contact_name||e.lead_name}setup_listener(){var e=this;frappe.realtime.on("call_"+this.call_log.id+"_disconnected",function(t){e.call_disconnected(t),frappe.realtime.off("call_"+e.call_log.id+"_disconnected")})}}$(document).on("app_ready",function(){frappe.realtime.on("show_call_popup",function(e){erpnext.call_popup?(erpnext.call_popup.update_call_log(e),erpnext.call_popup.dialog.show()):erpnext.call_popup=new t(e)})}),frappe.provide("frappe.ui.form");var a={};frappe.call({method:"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimension_filters",callback:function(e){erpnext.dimension_filters=e.message[0],a=e.message[1]}}),["GL Entry","Sales Invoice","Purchase Invoice","Payment Entry","Asset","Expense Claim","Stock Entry","Budget","Payroll Entry","Delivery Note","Shipping Rule","Loyalty Program","Fee Schedule","Fee Structure","Stock Reconciliation","Travel Request","Fees","POS Profile","Opening Invoice Creation Tool","Subscription","Purchase Order","Journal Entry","Material Request","Purchase Receipt","Landed Cost Item","Asset"].forEach(function(e){frappe.ui.form.on(e,{onload:function(e){erpnext.dimension_filters.forEach(function(t){frappe.model.with_doctype(t.document_type,function(){frappe.meta.has_field(t.document_type,"is_group")&&e.set_query(t.fieldname,{is_group:0})})})},company:function(e){e.doc.company&&Object.keys(a||{}).length>0&&a[e.doc.company]&&e.trigger("update_dimension")},update_dimension:function(t){erpnext.dimension_filters.forEach(function(r){if(t.is_new()&&t.doc.company&&Object.keys(a||{}).length>0&&a[t.doc.company]){var i=a[t.doc.company][r.fieldname];i&&(frappe.meta.has_field(e,r.fieldname)&&t.set_value(r.fieldname,i),$.each(t.doc.items||t.doc.accounts||[],function(e,t){frappe.model.set_value(t.doctype,t.name,r.fieldname,i)}))}})}})}),["Sales Invoice Item","Purchase Invoice Item","Purchase Order Item","Journal Entry Account","Material Request Item","Delivery Note Item","Purchase Receipt Item","Stock Entry Detail","Payment Entry Deduction","Landed Cost Item","Asset Value Adjustment","Opening Invoice Creation Tool Item","Subscription Plan"].forEach(function(e){frappe.ui.form.on(e,{items_add:function(e,t,a){erpnext.dimension_filters.forEach(function(r){var i=frappe.get_doc(t,a);e.script_manager.copy_from_first_row("items",i,[r.fieldname])})},accounts_add:function(e,t,a){erpnext.dimension_filters.forEach(function(r){var i=frappe.get_doc(t,a);e.script_manager.copy_from_first_row("accounts",i,[r.fieldname])})}})})}();
//# sourceMappingURL=erpnext.min.js.map
